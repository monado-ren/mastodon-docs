<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=/favicon.ico><link rel=stylesheet href=https://docs.monado.ren/style.min.ac66b095598a93816a47e5ef5b071058047fa4bd8770cb4515ca10c1ad6f91c0.css><script src=https://docs.monado.ren/main.min.db37c27117ff8400e5e30549f6806d2bc825668b596d81316c6148417f59bc72.js async></script><title>Security - Mastodon文档 -Monado-</title><meta property="og:type" content="article"><meta property="og:url" content="https://docs.monado.ren/en/spec/security/"><meta name=description content="Public key cryptography and supported signature schemes over HTTP and JSON-LD."><meta property="og:description" content="Public key cryptography and supported signature schemes over HTTP and JSON-LD."><meta name=twitter:description content="Public key cryptography and supported signature schemes over HTTP and JSON-LD."><meta name=twitter:title content="Security"><meta name=twitter:site content="@joinmastodon"><link rel=canonical href=https://docs.monado.ren/en/spec/security/></head><body><div class="container sidebar-layout"><nav class=sidebar><a class=brand href=/><img class=link-logo src=/brand.svg alt=Mastodon></a><ul><li><a href=/en/>What is Mastodon?</a></li><li><span class=sub-title>Using Mastodon</span><ul class=sub-menu><li><a href=/en/user/signup/>Signing up for an account</a></li><li><a href=/en/user/profile/>Setting up your profile</a></li><li><a href=/en/user/posting/>Posting toots</a></li><li><a href=/en/user/network/>Using the network features</a></li><li><a href=/en/user/moderating/>Dealing with unwanted content</a></li><li><a href=/en/user/discoverability/>Promoting yourself and others</a></li><li><a href=/en/user/preferences/>Set your preferences</a></li><li><a href=/en/user/contacts/>More settings</a></li><li><a href=/en/user/external/>Using Mastodon externally</a></li><li><a href=/en/user/moving/>Moving or leaving accounts</a></li><li><a href=/en/user/run-your-own/>Running your own server</a></li></ul></li><li><span class=sub-title>Running Mastodon</span><ul class=sub-menu><li><a href=/en/admin/prerequisites/>Preparing your machine</a></li><li><a href=/en/admin/install/>Installing from source</a></li><li><a href=/en/admin/config/>Configuring your environment</a></li><li><a href=/en/admin/optional/>Installing optional features</a><ul class=sub-menu><li><a href=/en/admin/optional/elasticsearch/>Full-text search</a></li><li><a href=/en/admin/optional/tor/>Hidden services</a></li><li><a href=/en/admin/optional/sso/>Single Sign On</a></li></ul></li><li><a href=/en/admin/setup/>Setting up your new instance</a></li><li><a href=/en/admin/tootctl/>Using the admin CLI</a></li><li><a href=/en/admin/upgrading/>Upgrading to a new release</a></li><li><a href=/en/admin/backups/>Backing up your server</a></li><li><a href=/en/admin/migrating/>Migrating to a new machine</a></li><li><a href=/en/admin/scaling/>Scaling up your server</a></li><li><a href=/en/admin/moderation/>Moderation actions</a></li><li><a href=/en/admin/troubleshooting/>Troubleshooting errors</a><ul class=sub-menu><li><a href=/en/admin/troubleshooting/index-corruption/>Database index corruption</a></li></ul></li></ul></li><li><span class=sub-title>Developing Mastodon apps</span><ul class=sub-menu><li><a href=/en/client/intro/>Getting started with the API</a></li><li><a href=/en/client/public/>Playing with public data</a></li><li><a href=/en/client/token/>Obtaining client app access</a></li><li><a href=/en/client/authorized/>Logging in with an account</a></li><li><a href=/en/client/guidelines/>Guidelines and best practices</a></li><li><a href=/en/client/libraries/>Libraries and implementations</a></li></ul></li><li><span class=sub-title>Contributing to Mastodon</span><ul class=sub-menu><li><a href=/en/dev/overview/>Technical overview</a></li><li><a href=/en/dev/setup/>Setting up a dev environment</a></li><li><a href=/en/dev/code/>Code structure</a></li><li><a href=/en/dev/routes/>Routes</a></li><li><a href=/en/dev/disclosure/>Bug bounties and responsible disclosure</a></li></ul></li><li><span class=sub-title>Spec compliance</span><ul class=sub-menu><li><a href=/en/spec/activitypub/>ActivityPub</a></li><li><a href=/en/spec/webfinger/>WebFinger</a></li><li><a href=/en/spec/security/ class=active>Security</a></li><li><a href=/en/spec/microformats/>Microformats</a></li><li><a href=/en/spec/oauth/>OAuth</a></li><li><a href=/en/spec/bearcaps/>Bearcaps</a></li></ul></li><li><span class=sub-title>REST API</span><ul class=sub-menu><li><a href=/en/api/oauth-scopes/>OAuth Scopes</a></li><li><a href=/en/api/rate-limits/>Rate limits</a></li></ul></li><li><span class=sub-title>API Methods</span><ul class=sub-menu><li><a href=/en/methods/apps/>apps</a><ul class=sub-menu><li><a href=/en/methods/apps/oauth/>oauth</a></li></ul></li><li><a href=/en/methods/accounts/>accounts</a><ul class=sub-menu><li><a href=/en/methods/accounts/bookmarks/>bookmarks</a></li><li><a href=/en/methods/accounts/favourites/>favourites</a></li><li><a href=/en/methods/accounts/mutes/>mutes</a></li><li><a href=/en/methods/accounts/blocks/>blocks</a></li><li><a href=/en/methods/accounts/domain_blocks/>domain_blocks</a></li><li><a href=/en/methods/accounts/filters/>filters</a></li><li><a href=/en/methods/accounts/reports/>reports</a></li><li><a href=/en/methods/accounts/follow_requests/>follow_requests</a></li><li><a href=/en/methods/accounts/endorsements/>endorsements</a></li><li><a href=/en/methods/accounts/featured_tags/>featured_tags</a></li><li><a href=/en/methods/accounts/preferences/>preferences</a></li><li><a href=/en/methods/accounts/suggestions/>suggestions</a></li></ul></li><li><a href=/en/methods/statuses/>statuses</a><ul class=sub-menu><li><a href=/en/methods/statuses/media/>media</a></li><li><a href=/en/methods/statuses/polls/>polls</a></li><li><a href=/en/methods/statuses/scheduled_statuses/>scheduled_statuses</a></li></ul></li><li><a href=/en/methods/timelines/>timelines</a><ul class=sub-menu><li><a href=/en/methods/timelines/conversations/>conversations</a></li><li><a href=/en/methods/timelines/lists/>lists</a></li><li><a href=/en/methods/timelines/markers/>markers</a></li><li><a href=/en/methods/timelines/streaming/>streaming</a></li></ul></li><li><a href=/en/methods/notifications/>notifications</a><ul class=sub-menu><li><a href=/en/methods/notifications/push/>push</a></li></ul></li><li><a href=/en/methods/search/>search</a></li><li><a href=/en/methods/instance/>instance</a><ul class=sub-menu><li><a href=/en/methods/instance/trends/>trends</a></li><li><a href=/en/methods/instance/directory/>directory</a></li><li><a href=/en/methods/instance/custom_emojis/>custom_emojis</a></li></ul></li><li><a href=/en/methods/admin/>admin</a></li><li><a href=/en/methods/announcements/>announcements</a></li><li><a href=/en/methods/proofs/>proofs</a></li><li><a href=/en/methods/oembed/>oembed</a></li></ul></li><li><span class=sub-title>API Entities</span><ul class=sub-menu><li><a href=/en/entities/account/>Account</a></li><li><a href=/en/entities/activity/>Activity</a></li><li><a href=/en/entities/admin-account/>Admin::Account</a></li><li><a href=/en/entities/admin-report/>Admin::Report</a></li><li><a href=/en/entities/announcement/>Announcement</a></li><li><a href=/en/entities/announcementreaction/>AnnouncementReaction</a></li><li><a href=/en/entities/application/>Application</a></li><li><a href=/en/entities/attachment/>Attachment</a></li><li><a href=/en/entities/card/>Card</a></li><li><a href=/en/entities/context/>Context</a></li><li><a href=/en/entities/conversation/>Conversation</a></li><li><a href=/en/entities/emoji/>Emoji</a></li><li><a href=/en/entities/error/>Error</a></li><li><a href=/en/entities/featuredtag/>FeaturedTag</a></li><li><a href=/en/entities/field/>Field</a></li><li><a href=/en/entities/filter/>Filter</a></li><li><a href=/en/entities/history/>History</a></li><li><a href=/en/entities/identityproof/>IdentityProof</a></li><li><a href=/en/entities/instance/>Instance</a></li><li><a href=/en/entities/list/>List</a></li><li><a href=/en/entities/marker/>Marker</a></li><li><a href=/en/entities/mention/>Mention</a></li><li><a href=/en/entities/notification/>Notification</a></li><li><a href=/en/entities/poll/>Poll</a></li><li><a href=/en/entities/preferences/>Preferences</a></li><li><a href=/en/entities/pushsubscription/>PushSubscription</a></li><li><a href=/en/entities/relationship/>Relationship</a></li><li><a href=/en/entities/report/>Report</a></li><li><a href=/en/entities/results/>Results</a></li><li><a href=/en/entities/scheduledstatus/>ScheduledStatus</a></li><li><a href=/en/entities/source/>Source</a></li><li><a href=/en/entities/status/>Status</a></li><li><a href=/en/entities/tag/>Tag</a></li><li><a href=/en/entities/token/>Token</a></li></ul></li></ul></nav><main><h1>Security</h1><p>Public key cryptography and supported signature schemes over HTTP and JSON-LD.</p><aside><nav id=TableOfContents><ul><li><ul><li><a href=#http>HTTP Signatures</a></li><li><a href=#ld>Linked Data Signatures</a></li></ul></li></ul></nav></aside><div class=e-content><h2 id=http>HTTP Signatures</h2><a href=https://github.com/tootsuite/mastodon/blob/master/app/lib/request.rb class=page-ref><div class=page-ref-icon><i class="fa fa-external-link-square-alt"></i></div>app/lib/request.rb</a><p><a href=https://w3c-dvcg.github.io/http-signatures/>HTTP Signatures</a> is a specification for signing HTTP messages by using a `Signature:` header with your HTTP request. Mastodon requires the use of HTTP Signatures in order to validate that any activity received was authored by the actor generating it. When secure mode is enabled, all GET requests require HTTP signatures as well.</p><p>For any HTTP request incoming to Mastodon, the following header should be attached:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http>Signature: keyId=&#34;https://my-example.com/actor#main-key&#34;,headers=&#34;(request-target) host date&#34;,signature=&#34;Y2FiYW...IxNGRiZDk4ZA==&#34;
</code></pre></div><p>The three parts of the <code>Signature:</code> header can be broken down like so:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http>Signature:
  keyId=&#34;https://my-example.com/actor#main-key&#34;,
  headers=&#34;(request-target) host date&#34;,
  signature=&#34;Y2FiYW...IxNGRiZDk4ZA==&#34;
</code></pre></div><p>The <code>keyId</code> should correspond to the actor and the key being used to generate the <code>signature</code>, whose value is equal to all parameters in <code>headers</code> concatenated together and signed by the key, then Base64-encoded. See <a href=/en/spec/activitypub/#public-key>ActivityPub > Public key</a> for more information on actor keys. An example key looks like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#f1fa8c>&#34;publicKey&#34;</span><span style=color:#ff79c6>:</span> {
    <span style=color:#f1fa8c>&#34;id&#34;</span><span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;https://my-example.com/actor#main-key&#34;</span>,
    <span style=color:#f1fa8c>&#34;owner&#34;</span><span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;https://my-example.com/actor&#34;</span>,
    <span style=color:#f1fa8c>&#34;publicKeyPem&#34;</span><span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvXc4vkECU2/CeuSo1wtn\nFoim94Ne1jBMYxTZ9wm2YTdJq1oiZKif06I2fOqDzY/4q/S9uccrE9Bkajv1dnkO\nVm31QjWlhVpSKynVxEWjVBO5Ienue8gND0xvHIuXf87o61poqjEoepvsQFElA5ym\novljWGSA/jpj7ozygUZhCXtaS2W5AD5tnBQUpcO0lhItYPYTjnmzcc4y2NbJV8hz\n2s2G8qKv8fyimE23gY1XrPJg+cRF+g4PqFXujjlJ7MihD9oqtLGxbu7o1cifTn3x\nBfIdPythWu5b4cujNsB3m3awJjVmx+MHQ9SugkSIYXV0Ina77cTNS0M2PYiH1PFR\nTwIDAQAB\n-----END PUBLIC KEY-----\n&#34;</span>
 },
</code></pre></div><p>See also: <a href=https://blog.joinmastodon.org/2018/07/how-to-make-friends-and-verify-requests/>https://blog.joinmastodon.org/2018/07/how-to-make-friends-and-verify-requests/</a></p><h3 id=http-sign>Creating HTTP signatures</h3><p>To create an HTTP signature, you will have to define which headers are being hashed and signed. For example, consider the following request being sent out:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#50fa7b>GET</span> /users/username/inbox <span style=color:#ff79c6>HTTP</span><span style=color:#ff79c6>/</span><span style=color:#bd93f9>1.1</span>
Host<span style=color:#ff79c6>:</span> mastodon.example
Date<span style=color:#ff79c6>:</span> 18 Dec 2019 10:08:46 GMT
Accept<span style=color:#ff79c6>:</span> application/activity+json
</code></pre></div><p>The signature string is constructed using the values of the HTTP headers defined in <code>headers</code>, joined by newlines. Typically, you will want to include the request target, as well as the host and the date. Mastodon assumes <code>Date:</code> header if none are provided. For the above request, to generate a <code>Signature:</code> with <code>headers="(request-target) host date"</code> we would generate the following string:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>(request-target): get /users/username/inbox
host: mastodon.example
date: 18 Dec 2019 10:08:46 GMT
</code></pre></div><p>Note that we don't care about the <code>Accept:</code> header because we won't be specifying it in <code>headers</code>.</p><p>The signature string is then hashed with SHA256 and signed with the actor's public key. The resulting value is attached as <code>signature</code> within the Signature: header. The final request looks like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#50fa7b>GET</span> /users/username/inbox <span style=color:#ff79c6>HTTP</span><span style=color:#ff79c6>/</span><span style=color:#bd93f9>1.1</span>
Host<span style=color:#ff79c6>:</span> mastodon.example
Date<span style=color:#ff79c6>:</span> 18 Dec 2019 10:08:46 GMT
Accept<span style=color:#ff79c6>:</span> application/activity+json
Signature<span style=color:#ff79c6>:</span> keyId=&#34;https://my-example.com/actor#main-key&#34;,headers=&#34;(request-target) host date&#34;,signature=&#34;Y2FiYW...IxNGRiZDk4ZA==&#34;
</code></pre></div><p>This request is functionally equivalent to saying that <code>https://my-example.com/actor</code> is requesting <code>https://mastodon.example/users/username/inbox</code> and is proving that they sent this request by signing <code>(request-target)</code>, <code>Host:</code>, and <code>Date:</code> with their public key linked at <code>keyId</code>, resulting in the provided <code>signature</code>.</p><h3 id=http-verify>Verifying HTTP signatures</h3><a href=https://github.com/tootsuite/mastodon/blob/master/app/controllers/concerns/signature_verification.rb class=page-ref><div class=page-ref-icon><i class="fa fa-external-link-square-alt"></i></div>app/controllers/concerns/signature_verification.rb</a><p>Consider the following request:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#50fa7b>GET</span> /users/username/inbox <span style=color:#ff79c6>HTTP</span><span style=color:#ff79c6>/</span><span style=color:#bd93f9>1.1</span>
Host<span style=color:#ff79c6>:</span> mastodon.example
Date<span style=color:#ff79c6>:</span> 18 Dec 2019 10:08:46 GMT
Accept<span style=color:#ff79c6>:</span> application/activity+json
Signature<span style=color:#ff79c6>:</span> keyId=&#34;https://my-example.com/actor#main-key&#34;,headers=&#34;(request-target) host date&#34;,signature=&#34;Y2FiYW...IxNGRiZDk4ZA==&#34;
</code></pre></div><p>Mastodon verifies the signature using the following algorithm:</p><ul><li>Split <code>Signature:</code> into its separate parameters.</li><li>Construct the signature string from the value of <code>headers</code>.</li><li>Fetch the <code>keyId</code> and resolve to an actor's <code>publicKey</code>.</li><li>SHA256 hash the signature string and compare to the Base64-decoded <code>signature</code> as decrypted by <code>publicKey[publicKeyPem]</code>.</li><li>Use the Date: header to check that the signed request was made within the past 12 hours.</li></ul><h2 id=ld>Linked Data Signatures</h2><a href=https://github.com/tootsuite/mastodon/blob/master/app/lib/activitypub/linked_data_signature.rb class=page-ref><div class=page-ref-icon><i class="fa fa-external-link-square-alt"></i></div>app/lib/activitypub/linked_data_signature.rb</a><p><a href=https://w3c-dvcg.github.io/ld-signatures/>Linked Data Signatures 1.0</a> is a specification for attaching cryptographic signatures to JSON-LD documents. LD Signatures are not used widely within Mastodon, but they are used in the following situations:</p><ul><li>When running a <a href=/en/admin/tootctl/#tootctl-self-destruct>self-destruct</a> sequence to send Delete activities to all known peers, the payload will use LD Signatures because HTTP Signatures will not be available. Receiving servers will process the signature by validating it against the locally cached actor key, since the HTTP server will no longer be hosting old actor information.</li><li>When accepting activities from a relay. Public activities can optionally be sent to a relay with LD Signatures, and any server subscribing to a relay does not have to manually refetch the activity from the origin. This prevents having potentially infinite servers attempt to load the status from your instance.</li></ul><h3 id=ld-sign>Creating LD signatures</h3><p>To create a signature, Mastodon uses the keypair attached to an actor at <code>https://mastodon.example/users/username#main-key</code>. It then creates an SHA256 hash of the document, signs it with the keypair, and Base64-strict-encodes the resulting output to derive a <code>signatureValue</code>. The following hash is merged into the JSON-LD document:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#f1fa8c>&#34;signature&#34;</span><span style=color:#ff79c6>:</span> {
    <span style=color:#f1fa8c>&#34;type&#34;</span><span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;RsaSignature2017&#34;</span>,
    <span style=color:#f1fa8c>&#34;creator&#34;</span><span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;https://mastodon.example/users/username#main-key&#34;</span>,
    <span style=color:#f1fa8c>&#34;created&#34;</span><span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;2019-12-08T03:48:33.901Z&#34;</span>,
    <span style=color:#f1fa8c>&#34;signatureValue&#34;</span><span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;s69F3mfddd99dGjmvjdjjs81e12jn121Gkm1&#34;</span>
}
</code></pre></div><div class="hint hint-warning"><div class=hint-icon><i class="fa fa-exclamation-circle"></i></div>Mastodon's current implementation of LD Signatures is somewhat outdated due to a change in the JSON-LD @context between the drafting stage and finalization stage of the specification. Mastodon expects a <code>type</code> of <code>RsaSignature2017</code> while the current specification instead defines <code>RsaSignature2018</code> via the namespace <code>https://w3id.org/security/v2</code>.</div><h3 id=ld-verify>Verifying LD signatures</h3><p>To verify a signature, Mastodon uses the following algorithm:</p><ul><li>Make sure that a <code>signature</code> exists and is a hash.</li><li>Make sure that <code>signature[type]</code> is <code>RsaSignature2017</code>.</li><li>Fetch the <code>signature[creator]</code> URI. Make sure the creator exists.</li><li>Strip <code>type</code>, <code>id</code>, and <code>signatureValue</code> from the <code>signature</code>, leaving only <code>signature[creator]</code> and <code>signature[created]</code>.</li><li>Base64-decode the <code>signatureValue</code> and verify it against the public key in <code>signature[creator]</code>.</li></ul><p style=color:#687590>Last updated December 27, 2020 · <a href=https://github.com/chasedream1129/mastodon-docs/tree/master/content/en/spec/security.md style=color:#687590>Improve this page</a></p></div></main></div></body></html>