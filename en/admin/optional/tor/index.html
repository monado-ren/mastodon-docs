<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=/favicon.ico><link rel=stylesheet href=https://docs.monado.ren/style.min.ac66b095598a93816a47e5ef5b071058047fa4bd8770cb4515ca10c1ad6f91c0.css><script src=https://docs.monado.ren/main.min.db37c27117ff8400e5e30549f6806d2bc825668b596d81316c6148417f59bc72.js async></script><title>Hidden services - Mastodon文档 -Monado-</title><meta property="og:type" content="article"><meta property="og:url" content="https://docs.monado.ren/en/admin/optional/tor/"><meta name=description content="Serving Mastodon through TOR hidden services."><meta property="og:description" content="Serving Mastodon through TOR hidden services."><meta name=twitter:description content="Serving Mastodon through TOR hidden services."><meta name=twitter:title content="Hidden services"><meta name=twitter:site content="@joinmastodon"><link rel=canonical href=https://docs.monado.ren/en/admin/optional/tor/></head><body><div class="container sidebar-layout"><nav class=sidebar><a class=brand href=/><img class=link-logo src=/brand.svg alt=Mastodon></a><ul><li><a href=/en/>What is Mastodon?</a></li><li><span class=sub-title>Using Mastodon</span><ul class=sub-menu><li><a href=/en/user/signup/>Signing up for an account</a></li><li><a href=/en/user/profile/>Setting up your profile</a></li><li><a href=/en/user/posting/>Posting toots</a></li><li><a href=/en/user/network/>Using the network features</a></li><li><a href=/en/user/moderating/>Dealing with unwanted content</a></li><li><a href=/en/user/discoverability/>Promoting yourself and others</a></li><li><a href=/en/user/preferences/>Set your preferences</a></li><li><a href=/en/user/contacts/>More settings</a></li><li><a href=/en/user/external/>Using Mastodon externally</a></li><li><a href=/en/user/moving/>Moving or leaving accounts</a></li><li><a href=/en/user/run-your-own/>Running your own server</a></li></ul></li><li><span class=sub-title>Running Mastodon</span><ul class=sub-menu><li><a href=/en/admin/prerequisites/>Preparing your machine</a></li><li><a href=/en/admin/install/>Installing from source</a></li><li><a href=/en/admin/config/>Configuring your environment</a></li><li><a href=/en/admin/optional/>Installing optional features</a><ul class=sub-menu><li><a href=/en/admin/optional/elasticsearch/>Full-text search</a></li><li><a href=/en/admin/optional/tor/ class=active>Hidden services</a></li><li><a href=/en/admin/optional/sso/>Single Sign On</a></li></ul></li><li><a href=/en/admin/setup/>Setting up your new instance</a></li><li><a href=/en/admin/tootctl/>Using the admin CLI</a></li><li><a href=/en/admin/upgrading/>Upgrading to a new release</a></li><li><a href=/en/admin/backups/>Backing up your server</a></li><li><a href=/en/admin/migrating/>Migrating to a new machine</a></li><li><a href=/en/admin/scaling/>Scaling up your server</a></li><li><a href=/en/admin/moderation/>Moderation actions</a></li><li><a href=/en/admin/troubleshooting/>Troubleshooting errors</a><ul class=sub-menu><li><a href=/en/admin/troubleshooting/index-corruption/>Database index corruption</a></li></ul></li></ul></li><li><span class=sub-title>Developing Mastodon apps</span><ul class=sub-menu><li><a href=/en/client/intro/>Getting started with the API</a></li><li><a href=/en/client/public/>Playing with public data</a></li><li><a href=/en/client/token/>Obtaining client app access</a></li><li><a href=/en/client/authorized/>Logging in with an account</a></li><li><a href=/en/client/guidelines/>Guidelines and best practices</a></li><li><a href=/en/client/libraries/>Libraries and implementations</a></li></ul></li><li><span class=sub-title>Contributing to Mastodon</span><ul class=sub-menu><li><a href=/en/dev/overview/>Technical overview</a></li><li><a href=/en/dev/setup/>Setting up a dev environment</a></li><li><a href=/en/dev/code/>Code structure</a></li><li><a href=/en/dev/routes/>Routes</a></li><li><a href=/en/dev/disclosure/>Bug bounties and responsible disclosure</a></li></ul></li><li><span class=sub-title>Spec compliance</span><ul class=sub-menu><li><a href=/en/spec/activitypub/>ActivityPub</a></li><li><a href=/en/spec/webfinger/>WebFinger</a></li><li><a href=/en/spec/security/>Security</a></li><li><a href=/en/spec/microformats/>Microformats</a></li><li><a href=/en/spec/oauth/>OAuth</a></li><li><a href=/en/spec/bearcaps/>Bearcaps</a></li></ul></li><li><span class=sub-title>REST API</span><ul class=sub-menu><li><a href=/en/api/oauth-scopes/>OAuth Scopes</a></li><li><a href=/en/api/rate-limits/>Rate limits</a></li></ul></li><li><span class=sub-title>API Methods</span><ul class=sub-menu><li><a href=/en/methods/apps/>apps</a><ul class=sub-menu><li><a href=/en/methods/apps/oauth/>oauth</a></li></ul></li><li><a href=/en/methods/accounts/>accounts</a><ul class=sub-menu><li><a href=/en/methods/accounts/bookmarks/>bookmarks</a></li><li><a href=/en/methods/accounts/favourites/>favourites</a></li><li><a href=/en/methods/accounts/mutes/>mutes</a></li><li><a href=/en/methods/accounts/blocks/>blocks</a></li><li><a href=/en/methods/accounts/domain_blocks/>domain_blocks</a></li><li><a href=/en/methods/accounts/filters/>filters</a></li><li><a href=/en/methods/accounts/reports/>reports</a></li><li><a href=/en/methods/accounts/follow_requests/>follow_requests</a></li><li><a href=/en/methods/accounts/endorsements/>endorsements</a></li><li><a href=/en/methods/accounts/featured_tags/>featured_tags</a></li><li><a href=/en/methods/accounts/preferences/>preferences</a></li><li><a href=/en/methods/accounts/suggestions/>suggestions</a></li></ul></li><li><a href=/en/methods/statuses/>statuses</a><ul class=sub-menu><li><a href=/en/methods/statuses/media/>media</a></li><li><a href=/en/methods/statuses/polls/>polls</a></li><li><a href=/en/methods/statuses/scheduled_statuses/>scheduled_statuses</a></li></ul></li><li><a href=/en/methods/timelines/>timelines</a><ul class=sub-menu><li><a href=/en/methods/timelines/conversations/>conversations</a></li><li><a href=/en/methods/timelines/lists/>lists</a></li><li><a href=/en/methods/timelines/markers/>markers</a></li><li><a href=/en/methods/timelines/streaming/>streaming</a></li></ul></li><li><a href=/en/methods/notifications/>notifications</a><ul class=sub-menu><li><a href=/en/methods/notifications/push/>push</a></li></ul></li><li><a href=/en/methods/search/>search</a></li><li><a href=/en/methods/instance/>instance</a><ul class=sub-menu><li><a href=/en/methods/instance/trends/>trends</a></li><li><a href=/en/methods/instance/directory/>directory</a></li><li><a href=/en/methods/instance/custom_emojis/>custom_emojis</a></li></ul></li><li><a href=/en/methods/admin/>admin</a></li><li><a href=/en/methods/announcements/>announcements</a></li><li><a href=/en/methods/proofs/>proofs</a></li><li><a href=/en/methods/oembed/>oembed</a></li></ul></li><li><span class=sub-title>API Entities</span><ul class=sub-menu><li><a href=/en/entities/account/>Account</a></li><li><a href=/en/entities/activity/>Activity</a></li><li><a href=/en/entities/admin-account/>Admin::Account</a></li><li><a href=/en/entities/admin-report/>Admin::Report</a></li><li><a href=/en/entities/announcement/>Announcement</a></li><li><a href=/en/entities/announcementreaction/>AnnouncementReaction</a></li><li><a href=/en/entities/application/>Application</a></li><li><a href=/en/entities/attachment/>Attachment</a></li><li><a href=/en/entities/card/>Card</a></li><li><a href=/en/entities/context/>Context</a></li><li><a href=/en/entities/conversation/>Conversation</a></li><li><a href=/en/entities/emoji/>Emoji</a></li><li><a href=/en/entities/error/>Error</a></li><li><a href=/en/entities/featuredtag/>FeaturedTag</a></li><li><a href=/en/entities/field/>Field</a></li><li><a href=/en/entities/filter/>Filter</a></li><li><a href=/en/entities/history/>History</a></li><li><a href=/en/entities/identityproof/>IdentityProof</a></li><li><a href=/en/entities/instance/>Instance</a></li><li><a href=/en/entities/list/>List</a></li><li><a href=/en/entities/marker/>Marker</a></li><li><a href=/en/entities/mention/>Mention</a></li><li><a href=/en/entities/notification/>Notification</a></li><li><a href=/en/entities/poll/>Poll</a></li><li><a href=/en/entities/preferences/>Preferences</a></li><li><a href=/en/entities/pushsubscription/>PushSubscription</a></li><li><a href=/en/entities/relationship/>Relationship</a></li><li><a href=/en/entities/report/>Report</a></li><li><a href=/en/entities/results/>Results</a></li><li><a href=/en/entities/scheduledstatus/>ScheduledStatus</a></li><li><a href=/en/entities/source/>Source</a></li><li><a href=/en/entities/status/>Status</a></li><li><a href=/en/entities/tag/>Tag</a></li><li><a href=/en/entities/token/>Token</a></li></ul></li></ul></nav><main><h1>Hidden services</h1><p>Serving Mastodon through TOR hidden services.</p><aside><nav id=TableOfContents><ul><li><ul><li><a href=#install>Installing Tor</a></li><li><a href=#configure>Configure Tor</a></li><li><a href=#nginx>Move your Mastodon configuration</a></li><li><a href=#http>Serve Tor over http</a></li><li><a href=#gotchas>Gotchas</a></li></ul></li></ul></nav></aside><div class=e-content><p>Mastodon can be served through Tor as an onion service. This will give you a *.onion address that can only be used while connected to the Tor network.</p><h2 id=install>Installing Tor</h2><p>First Tor’s Debian archive needs to be added to apt.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>deb https://deb.torproject.org/torproject.org stretch main
deb-src https://deb.torproject.org/torproject.org stretch main
</code></pre></div><p>Next add the gpg key.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl https://deb.torproject.org/torproject.org/A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89.asc | gpg --import
gpg --export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 | apt-key add -
</code></pre></div><p>Finally install the required packages.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apt install tor deb.torproject.org-keyring
</code></pre></div><h2 id=configure>Configure Tor</h2><p>Edit the file at <code>/etc/tor/torrc</code> and add the following configuration.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>HiddenServiceDir /var/lib/tor/hidden_service/
HiddenServiceVersion 3
HiddenServicePort 80 127.0.0.1:80
</code></pre></div><p>Restart tor.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo service tor restart
</code></pre></div><p>Your tor hostname can now be found at <code>/var/lib/tor/hidden_service/hostname</code>.</p><h2 id=nginx>Move your Mastodon configuration</h2><p>We will need to tell Nginx about your Mastodon configuration twice. To keep things <a href=https://en.wikipedia.org/wiki/Don%27t_repeat_yourself>DRY</a> we need to move the Mastodon configuration into its own file that can be referenced.</p><p>Create a new file at <code>/etc/nginx/snippets/mastodon.conf</code>. Put all of your Mastodon configuration parameters in this file with the exception of the <code>listen</code>, <code>server_name</code>, <code>include</code> and all of the SSL options. Your new file may look something like this.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#ff79c6>add_header</span> <span style=color:#f1fa8c>Referrer-Policy</span> <span style=color:#f1fa8c>&#34;same-origin&#34;</span>;

<span style=color:#ff79c6>keepalive_timeout</span>    <span style=color:#bd93f9>70</span>;
<span style=color:#ff79c6>sendfile</span>             on;
<span style=color:#ff79c6>client_max_body_size</span> <span style=color:#bd93f9>80m</span>;

<span style=color:#ff79c6>root</span> <span style=color:#f1fa8c>/home/mastodon/live/public</span>;

<span style=color:#6272a4># …
</span><span style=color:#6272a4></span>
<span style=color:#ff79c6>error_page</span> <span style=color:#bd93f9>500</span> <span style=color:#bd93f9>501</span> <span style=color:#bd93f9>502</span> <span style=color:#bd93f9>503</span> <span style=color:#bd93f9>504</span> <span style=color:#f1fa8c>/500.html</span>;

<span style=color:#ff79c6>access_log</span> <span style=color:#f1fa8c>/var/log/nginx/mastodon_access.log</span>;
<span style=color:#ff79c6>error_log</span> <span style=color:#f1fa8c>/var/log/nginx/mastodon_error.log</span> <span style=color:#f1fa8c>warn</span>;
</code></pre></div><p>In place of your old Mastodon configuration add an include directive to this new configuration file.</p><p>Your Nginx configuration file will be left looking something like this.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#ff79c6>server</span> {
  <span style=color:#ff79c6>listen</span> <span style=color:#bd93f9>80</span>;
  <span style=color:#ff79c6>server_name</span> <span style=color:#f1fa8c>mastodon.myhosting.com</span>;
  <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>301</span> <span style=color:#f1fa8c>https://</span><span style=color:#8be9fd;font-style:italic>$server_name$request_uri</span>;
}

<span style=color:#ff79c6>map</span> <span style=color:#8be9fd;font-style:italic>$http_upgrade</span> <span style=color:#8be9fd;font-style:italic>$connection_upgrade</span> {
  <span style=color:#ff79c6>default</span> <span style=color:#f1fa8c>upgrade</span>;
  <span style=color:#ff79c6>&#39;&#39;</span>      <span style=color:#f1fa8c>close</span>;
}

<span style=color:#ff79c6>server</span> {
  <span style=color:#ff79c6>listen</span> <span style=color:#bd93f9>443</span> <span style=color:#f1fa8c>ssl</span> <span style=color:#f1fa8c>http2</span>;
  <span style=color:#ff79c6>list</span> <span style=color:#f1fa8c>[::]:443</span> <span style=color:#f1fa8c>ssl</span> <span style=color:#f1fa8c>http2</span>;
  <span style=color:#ff79c6>server_name</span> <span style=color:#f1fa8c>mastodon.myhosting.com</span>;
  <span style=color:#ff79c6>include</span> <span style=color:#f1fa8c>/etc/nginx/snippets/mastodon.conf</span>;

  <span style=color:#ff79c6>ssl_certificate</span> <span style=color:#f1fa8c>/etc/letsencrypt/live/mastodon.myhosting.com/fullchain.pem</span>;
  <span style=color:#ff79c6>ssl_certificate_key</span> <span style=color:#f1fa8c>/etc/letsencrypt/live/mastodon.myhosting.com/privkey.pem</span>;
}
</code></pre></div><h2 id=http>Serve Tor over http</h2><p>While it may be tempting to serve your Tor version of Mastodon over https it is not a good idea for most people. See <a href=https://blog.torproject.org/facebook-hidden-services-and-https-certs>this</a> blog post from the Tor Project about why https certificates do not add value. Since you cannot get an SSL cert for an onion domain, you will also be plagued with certificate errors when trying to use your Mastodon instance. A Tor developer has more recently spelled out the reasons why serving a Tor service over https is not beneficial for most use cases <a href=https://matt.traudt.xyz/p/o44SnkW2.html>here</a>.</p><p>The solution is to serve your Mastodon instance over http, but only for Tor. This can be added by prepending an additional configuration to your Nginx configuration.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#ff79c6>server</span> {
  <span style=color:#ff79c6>listen</span> <span style=color:#bd93f9>80</span>;
  <span style=color:#ff79c6>server_name</span> <span style=color:#f1fa8c>mastodon.qKnFwnNH2oH4QhQ7CoRf7HYj8wCwpDwsa8ohJmcPG9JodMZvVA6psKq7qKnFwnNH2oH4QhQ7CoRf7HYj8wCwpDwsa8ohJmcPG9JodMZvVA6psKq7.onion</span>;
  <span style=color:#ff79c6>include</span> <span style=color:#f1fa8c>/etc/nginx/snippets/mastodon.conf</span>;
}

<span style=color:#ff79c6>server</span> {
  <span style=color:#ff79c6>listen</span> <span style=color:#bd93f9>80</span>;
  <span style=color:#ff79c6>server_name</span> <span style=color:#f1fa8c>mastodon.myhosting.com</span>;
  <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>301</span> <span style=color:#f1fa8c>https://</span><span style=color:#8be9fd;font-style:italic>$server_name$request_uri</span>;
}

<span style=color:#ff79c6>map</span> <span style=color:#8be9fd;font-style:italic>$http_upgrade</span> <span style=color:#8be9fd;font-style:italic>$connection_upgrade</span> {
  <span style=color:#ff79c6>default</span> <span style=color:#f1fa8c>upgrade</span>;
  <span style=color:#ff79c6>&#39;&#39;</span>      <span style=color:#f1fa8c>close</span>;
}

<span style=color:#ff79c6>server</span> {
  <span style=color:#ff79c6>listen</span> <span style=color:#bd93f9>443</span> <span style=color:#f1fa8c>ssl</span> <span style=color:#f1fa8c>http2</span>;
  <span style=color:#ff79c6>list</span> <span style=color:#f1fa8c>[::]:443</span> <span style=color:#f1fa8c>ssl</span> <span style=color:#f1fa8c>http2</span>;
  <span style=color:#ff79c6>server_name</span> <span style=color:#f1fa8c>mastodon.myhosting.com</span>;
  <span style=color:#ff79c6>include</span> <span style=color:#f1fa8c>/etc/nginx/snippets/mastodon.conf</span>;

  <span style=color:#ff79c6>ssl_certificate</span> <span style=color:#f1fa8c>/etc/letsencrypt/live/mastodon.myhosting.com/fullchain.pem</span>;
  <span style=color:#ff79c6>ssl_certificate_key</span> <span style=color:#f1fa8c>/etc/letsencrypt/live/mastodon.myhosting.com/privkey.pem</span>;
}
</code></pre></div><p>Replace the long hash provided here with your Tor domain located in the file at <code>/var/lib/tor/hidden_service/hostname</code>.</p><p>Note that the onion hostname has been prefixed with “mastodon.”. Your Tor address acts a wildcard domain. All subdomains will be routed through, and you can configure Nginx to respond to any subdomain you wish. If you do not wish to host any other services on your tor address you can omit the subdomain, or choose a different subdomain.</p><p>Here you can see the payoff of moving your mastodon configurations to a different file. Without this all of your configurations would have to be copied to both places. Any change to your configuration would have to be made both places.</p><p>Restart your web server.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>service nginx restart
</code></pre></div><h2 id=gotchas>Gotchas</h2><p>There are a few things you will need to be aware of. Certain redirects will push your users to https. They will have to manually replace the URL with http to continue.</p><p>Various resources, such as images, will still be offered through your regular non-Tor domain. How much of a problem this is will depend greatly on your user’s level of caution.</p><p style=color:#687590>Last updated July 26, 2020 · <a href=https://github.com/chasedream1129/mastodon-docs/tree/master/content/en/admin/optional/tor.md style=color:#687590>Improve this page</a><br>Also available in:
<a href=https://docs.monado.ren/admin/optional/tor/ style=color:#687590 hreflang=zh-cn>简体中文</a></p></div></main></div></body></html>