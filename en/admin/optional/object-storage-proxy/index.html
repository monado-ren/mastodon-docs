<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=/favicon.ico><link rel=stylesheet href=https://docs.monado.ren/style.min.ac66b095598a93816a47e5ef5b071058047fa4bd8770cb4515ca10c1ad6f91c0.css><script src=https://docs.monado.ren/main.min.db37c27117ff8400e5e30549f6806d2bc825668b596d81316c6148417f59bc72.js async></script><title>Proxying object storage through nginx - Mastodon文档 -Monado-</title><meta property="og:type" content="article"><meta property="og:url" content="https://docs.monado.ren/en/admin/optional/object-storage-proxy/"><meta name=description content="Serving user-uploaded files in Mastodon from your own domain"><meta property="og:description" content="Serving user-uploaded files in Mastodon from your own domain"><meta name=twitter:description content="Serving user-uploaded files in Mastodon from your own domain"><meta name=twitter:title content="Proxying object storage through nginx"><meta name=twitter:site content="@joinmastodon"><link rel=canonical href=https://docs.monado.ren/en/admin/optional/object-storage-proxy/></head><body><div class="container sidebar-layout"><nav class=sidebar><a class=brand href=/><img class=link-logo src=/brand.svg alt=Mastodon></a><ul><li><a href=/en/>What is Mastodon?</a></li><li><span class=sub-title>Using Mastodon</span><ul class=sub-menu><li><a href=/en/user/signup/>Signing up for an account</a></li><li><a href=/en/user/profile/>Setting up your profile</a></li><li><a href=/en/user/posting/>Posting toots</a></li><li><a href=/en/user/network/>Using the network features</a></li><li><a href=/en/user/moderating/>Dealing with unwanted content</a></li><li><a href=/en/user/discoverability/>Promoting yourself and others</a></li><li><a href=/en/user/preferences/>Set your preferences</a></li><li><a href=/en/user/contacts/>More settings</a></li><li><a href=/en/user/external/>Using Mastodon externally</a></li><li><a href=/en/user/moving/>Moving or leaving accounts</a></li><li><a href=/en/user/run-your-own/>Running your own server</a></li></ul></li><li><span class=sub-title>Running Mastodon</span><ul class=sub-menu><li><a href=/en/admin/prerequisites/>Preparing your machine</a></li><li><a href=/en/admin/install/>Installing from source</a></li><li><a href=/en/admin/config/>Configuring your environment</a></li><li><a href=/en/admin/optional/>Installing optional features</a><ul class=sub-menu><li><a href=/en/admin/optional/elasticsearch/>Full-text search</a></li><li><a href=/en/admin/optional/tor/>Hidden services</a></li><li><a href=/en/admin/optional/sso/>Single Sign On</a></li></ul></li><li><a href=/en/admin/setup/>Setting up your new instance</a></li><li><a href=/en/admin/tootctl/>Using the admin CLI</a></li><li><a href=/en/admin/upgrading/>Upgrading to a new release</a></li><li><a href=/en/admin/backups/>Backing up your server</a></li><li><a href=/en/admin/migrating/>Migrating to a new machine</a></li><li><a href=/en/admin/scaling/>Scaling up your server</a></li><li><a href=/en/admin/moderation/>Moderation actions</a></li><li><a href=/en/admin/troubleshooting/>Troubleshooting errors</a><ul class=sub-menu><li><a href=/en/admin/troubleshooting/index-corruption/>Database index corruption</a></li></ul></li></ul></li><li><span class=sub-title>Developing Mastodon apps</span><ul class=sub-menu><li><a href=/en/client/intro/>Getting started with the API</a></li><li><a href=/en/client/public/>Playing with public data</a></li><li><a href=/en/client/token/>Obtaining client app access</a></li><li><a href=/en/client/authorized/>Logging in with an account</a></li><li><a href=/en/client/guidelines/>Guidelines and best practices</a></li><li><a href=/en/client/libraries/>Libraries and implementations</a></li></ul></li><li><span class=sub-title>Contributing to Mastodon</span><ul class=sub-menu><li><a href=/en/dev/overview/>Technical overview</a></li><li><a href=/en/dev/setup/>Setting up a dev environment</a></li><li><a href=/en/dev/code/>Code structure</a></li><li><a href=/en/dev/routes/>Routes</a></li><li><a href=/en/dev/disclosure/>Bug bounties and responsible disclosure</a></li></ul></li><li><span class=sub-title>Spec compliance</span><ul class=sub-menu><li><a href=/en/spec/activitypub/>ActivityPub</a></li><li><a href=/en/spec/webfinger/>WebFinger</a></li><li><a href=/en/spec/security/>Security</a></li><li><a href=/en/spec/microformats/>Microformats</a></li><li><a href=/en/spec/oauth/>OAuth</a></li><li><a href=/en/spec/bearcaps/>Bearcaps</a></li></ul></li><li><span class=sub-title>REST API</span><ul class=sub-menu><li><a href=/en/api/oauth-scopes/>OAuth Scopes</a></li><li><a href=/en/api/rate-limits/>Rate limits</a></li></ul></li><li><span class=sub-title>API Methods</span><ul class=sub-menu><li><a href=/en/methods/apps/>apps</a><ul class=sub-menu><li><a href=/en/methods/apps/oauth/>oauth</a></li></ul></li><li><a href=/en/methods/accounts/>accounts</a><ul class=sub-menu><li><a href=/en/methods/accounts/bookmarks/>bookmarks</a></li><li><a href=/en/methods/accounts/favourites/>favourites</a></li><li><a href=/en/methods/accounts/mutes/>mutes</a></li><li><a href=/en/methods/accounts/blocks/>blocks</a></li><li><a href=/en/methods/accounts/domain_blocks/>domain_blocks</a></li><li><a href=/en/methods/accounts/filters/>filters</a></li><li><a href=/en/methods/accounts/reports/>reports</a></li><li><a href=/en/methods/accounts/follow_requests/>follow_requests</a></li><li><a href=/en/methods/accounts/endorsements/>endorsements</a></li><li><a href=/en/methods/accounts/featured_tags/>featured_tags</a></li><li><a href=/en/methods/accounts/preferences/>preferences</a></li><li><a href=/en/methods/accounts/suggestions/>suggestions</a></li></ul></li><li><a href=/en/methods/statuses/>statuses</a><ul class=sub-menu><li><a href=/en/methods/statuses/media/>media</a></li><li><a href=/en/methods/statuses/polls/>polls</a></li><li><a href=/en/methods/statuses/scheduled_statuses/>scheduled_statuses</a></li></ul></li><li><a href=/en/methods/timelines/>timelines</a><ul class=sub-menu><li><a href=/en/methods/timelines/conversations/>conversations</a></li><li><a href=/en/methods/timelines/lists/>lists</a></li><li><a href=/en/methods/timelines/markers/>markers</a></li><li><a href=/en/methods/timelines/streaming/>streaming</a></li></ul></li><li><a href=/en/methods/notifications/>notifications</a><ul class=sub-menu><li><a href=/en/methods/notifications/push/>push</a></li></ul></li><li><a href=/en/methods/search/>search</a></li><li><a href=/en/methods/instance/>instance</a><ul class=sub-menu><li><a href=/en/methods/instance/trends/>trends</a></li><li><a href=/en/methods/instance/directory/>directory</a></li><li><a href=/en/methods/instance/custom_emojis/>custom_emojis</a></li></ul></li><li><a href=/en/methods/admin/>admin</a></li><li><a href=/en/methods/announcements/>announcements</a></li><li><a href=/en/methods/proofs/>proofs</a></li><li><a href=/en/methods/oembed/>oembed</a></li></ul></li><li><span class=sub-title>API Entities</span><ul class=sub-menu><li><a href=/en/entities/account/>Account</a></li><li><a href=/en/entities/activity/>Activity</a></li><li><a href=/en/entities/admin-account/>Admin::Account</a></li><li><a href=/en/entities/admin-report/>Admin::Report</a></li><li><a href=/en/entities/announcement/>Announcement</a></li><li><a href=/en/entities/announcementreaction/>AnnouncementReaction</a></li><li><a href=/en/entities/application/>Application</a></li><li><a href=/en/entities/attachment/>Attachment</a></li><li><a href=/en/entities/card/>Card</a></li><li><a href=/en/entities/context/>Context</a></li><li><a href=/en/entities/conversation/>Conversation</a></li><li><a href=/en/entities/emoji/>Emoji</a></li><li><a href=/en/entities/error/>Error</a></li><li><a href=/en/entities/featuredtag/>FeaturedTag</a></li><li><a href=/en/entities/field/>Field</a></li><li><a href=/en/entities/filter/>Filter</a></li><li><a href=/en/entities/history/>History</a></li><li><a href=/en/entities/identityproof/>IdentityProof</a></li><li><a href=/en/entities/instance/>Instance</a></li><li><a href=/en/entities/list/>List</a></li><li><a href=/en/entities/marker/>Marker</a></li><li><a href=/en/entities/mention/>Mention</a></li><li><a href=/en/entities/notification/>Notification</a></li><li><a href=/en/entities/poll/>Poll</a></li><li><a href=/en/entities/preferences/>Preferences</a></li><li><a href=/en/entities/pushsubscription/>PushSubscription</a></li><li><a href=/en/entities/relationship/>Relationship</a></li><li><a href=/en/entities/report/>Report</a></li><li><a href=/en/entities/results/>Results</a></li><li><a href=/en/entities/scheduledstatus/>ScheduledStatus</a></li><li><a href=/en/entities/source/>Source</a></li><li><a href=/en/entities/status/>Status</a></li><li><a href=/en/entities/tag/>Tag</a></li><li><a href=/en/entities/token/>Token</a></li></ul></li></ul></nav><main><h1>Proxying object storage through nginx</h1><p>Serving user-uploaded files in Mastodon from your own domain</p><aside><nav id=TableOfContents></nav></aside><div class=e-content><p>When you are using Mastodon with an object storage provider like Amazon S3, Wasabi, Google Cloud or other, by default the URLs of the files go through the storage providers themselves. This has the following downsides:</p><ul><li>Bandwidth is usually metered and very expensive</li><li>URLs will be broken if you decide to switch providers later</li></ul><p>You can instead serve the files from your own domain, caching them in the process. Access patterns on Mastodon are such that <strong>new files are usually accessed simultaneously by a lot of clients</strong> as new posts stream in through the streaming API or as they get distributed through federation; older content is accessed comparatively rarely. For that reason, caching alone would not reduce bandwidth consumed by your proxy from the actual object storage. To mitigate this, we can use a <strong>cache lock</strong> mechanism that ensures that only one proxy request is made at the same time.</p><p>Here is an example nginx configuration that accomplishes this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#ff79c6>server</span> {
  <span style=color:#ff79c6>listen</span> <span style=color:#bd93f9>443</span> <span style=color:#f1fa8c>ssl</span> <span style=color:#f1fa8c>http2</span>;
  <span style=color:#ff79c6>listen</span> <span style=color:#f1fa8c>[::]:443</span> <span style=color:#f1fa8c>ssl</span> <span style=color:#f1fa8c>http2</span>;
  <span style=color:#ff79c6>server_name</span> <span style=color:#f1fa8c>files.example.com</span>;
  <span style=color:#ff79c6>root</span> <span style=color:#f1fa8c>/var/www/html</span>;

  <span style=color:#ff79c6>keepalive_timeout</span> <span style=color:#bd93f9>30</span>;

  <span style=color:#ff79c6>location</span> = <span style=color:#f1fa8c>/</span> {
    <span style=color:#ff79c6>index</span> <span style=color:#f1fa8c>index.html</span>;
  }

  <span style=color:#ff79c6>location</span> <span style=color:#f1fa8c>/</span> {
    <span style=color:#ff79c6>try_files</span> <span style=color:#8be9fd;font-style:italic>$uri</span> <span style=color:#f1fa8c>@s3</span>;
  }

  <span style=color:#ff79c6>set</span> <span style=color:#8be9fd;font-style:italic>$s3_backend</span> <span style=color:#f1fa8c>&#39;https://YOUR_BUCKET_NAME.YOUR_S3_HOSTNAME&#39;</span>;

  <span style=color:#ff79c6>location</span> <span style=color:#f1fa8c>@s3</span> {
    <span style=color:#ff79c6>limit_except</span> <span style=color:#f1fa8c>GET</span> {
      <span style=color:#ff79c6>deny</span> <span style=color:#f1fa8c>all</span>;
    }

    <span style=color:#ff79c6>resolver</span> <span style=color:#bd93f9>8</span><span style=color:#f1fa8c>.8.8.8</span>;
    <span style=color:#ff79c6>proxy_set_header</span> <span style=color:#f1fa8c>Host</span> <span style=color:#f1fa8c>YOUR_S3_HOSTNAME</span>;
    <span style=color:#ff79c6>proxy_set_header</span> <span style=color:#f1fa8c>Connection</span> <span style=color:#f1fa8c>&#39;&#39;</span>;
    <span style=color:#ff79c6>proxy_set_header</span> <span style=color:#f1fa8c>Authorization</span> <span style=color:#f1fa8c>&#39;&#39;</span>;
    <span style=color:#ff79c6>proxy_hide_header</span> <span style=color:#f1fa8c>Set-Cookie</span>;
    <span style=color:#ff79c6>proxy_hide_header</span> <span style=color:#f1fa8c>&#39;Access-Control-Allow-Origin&#39;</span>;
    <span style=color:#ff79c6>proxy_hide_header</span> <span style=color:#f1fa8c>&#39;Access-Control-Allow-Methods&#39;</span>;
    <span style=color:#ff79c6>proxy_hide_header</span> <span style=color:#f1fa8c>&#39;Access-Control-Allow-Headers&#39;</span>;
    <span style=color:#ff79c6>proxy_hide_header</span> <span style=color:#f1fa8c>x-amz-id-2</span>;
    <span style=color:#ff79c6>proxy_hide_header</span> <span style=color:#f1fa8c>x-amz-request-id</span>;
    <span style=color:#ff79c6>proxy_hide_header</span> <span style=color:#f1fa8c>x-amz-meta-server-side-encryption</span>;
    <span style=color:#ff79c6>proxy_hide_header</span> <span style=color:#f1fa8c>x-amz-server-side-encryption</span>;
    <span style=color:#ff79c6>proxy_hide_header</span> <span style=color:#f1fa8c>x-amz-bucket-region</span>;
    <span style=color:#ff79c6>proxy_hide_header</span> <span style=color:#f1fa8c>x-amzn-requestid</span>;
    <span style=color:#ff79c6>proxy_ignore_headers</span> <span style=color:#f1fa8c>Set-Cookie</span>;
    <span style=color:#ff79c6>proxy_pass</span> <span style=color:#8be9fd;font-style:italic>$s3_backend$uri</span>;
    <span style=color:#ff79c6>proxy_intercept_errors</span> off;

    <span style=color:#ff79c6>proxy_cache</span> <span style=color:#f1fa8c>CACHE</span>;
    <span style=color:#ff79c6>proxy_cache_valid</span> <span style=color:#bd93f9>200</span> <span style=color:#f1fa8c>48h</span>;
    <span style=color:#ff79c6>proxy_cache_use_stale</span> <span style=color:#f1fa8c>error</span> <span style=color:#f1fa8c>timeout</span> <span style=color:#f1fa8c>updating</span> <span style=color:#f1fa8c>http_500</span> <span style=color:#f1fa8c>http_502</span> <span style=color:#f1fa8c>http_503</span> <span style=color:#f1fa8c>http_504</span>;
    <span style=color:#ff79c6>proxy_cache_lock</span> on;

    <span style=color:#ff79c6>expires</span> <span style=color:#f1fa8c>1y</span>;
    <span style=color:#ff79c6>add_header</span> <span style=color:#f1fa8c>Cache-Control</span> <span style=color:#f1fa8c>public</span>;
    <span style=color:#ff79c6>add_header</span> <span style=color:#f1fa8c>&#39;Access-Control-Allow-Origin&#39;</span> <span style=color:#f1fa8c>&#39;*&#39;</span>;
    <span style=color:#ff79c6>add_header</span> <span style=color:#f1fa8c>X-Cache-Status</span> <span style=color:#8be9fd;font-style:italic>$upstream_cache_status</span>;
  }
}
</code></pre></div><div class="hint hint-info"><div class=hint-icon><i class="fa fa-info-circle"></i></div>We are using <code>$s3_backend</code> as a variable to force nginx to perform a DNS resolution on its value, as the IP of the object storage provider may not always remain the same.</div><p>This configuration does a few different things:</p><ul><li>Blocks all but GET requests to the object storage provider</li><li>Prevents any authenticated requests to the object storage provider</li><li>Prevents the object storage provider from setting cookies</li><li>Removes unnecessary headers returned by the object storage provider</li><li>Caches valid files for at most 48 hours</li><li>Allows older cache to be used if the object storage is unavailable</li><li>Uses a cache lock to prevent simultaneous requests to the object storage</li><li>Makes all returned files cacheable by browsers for up to a year</li><li>Adds CORS headers necessary for Mastodon's web UI</li><li>Adds a special header that tells you if your request was a cache hit or miss</li></ul><p>Make sure to replace:</p><ul><li><code>files.example.com</code></li><li><code>YOUR_BUCKET_NAME</code></li><li><code>YOUR_S3_HOSTNAME</code></li></ul><p>With your actual values. Save your configuration to <code>/etc/nginx/sites-available/files.example.com</code> and then enable it with:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ln -s /etc/nginx/sites-available/files.example.com /etc/nginx/sites-enabled/
systemctl reload nginx
</code></pre></div><p>You'll also want to get a SSL certificate for it:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>certbot --nginx -d files.example.com
systemctl reload nginx
</code></pre></div><p>At last, you'll want to make sure Mastodon is using your new proxy to generate file URLs. Edit your Mastodon's <code>.env.production</code> to add:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8be9fd;font-style:italic>S3_ALIAS_HOST</span><span style=color:#ff79c6>=</span>files.example.com
</code></pre></div><p>And restart Mastodon:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl restart mastodon-sidekiq
systemctl reload mastodon-web
</code></pre></div><div class="hint hint-success"><div class=hint-icon><i class="fa fa-check-circle"></i></div><strong>You can now visit your Mastodon in the browser to confirm everything loads correctly</strong></div><p style=color:#687590>Last updated September 28, 2020 · <a href=https://github.com/chasedream1129/mastodon-docs/tree/master/content/en/admin/optional/object-storage-proxy.md style=color:#687590>Improve this page</a></p></div></main></div></body></html>