<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=/favicon.ico><link rel=stylesheet href=https://docs.monado.ren/style.min.ac66b095598a93816a47e5ef5b071058047fa4bd8770cb4515ca10c1ad6f91c0.css><script src=https://docs.monado.ren/main.min.db37c27117ff8400e5e30549f6806d2bc825668b596d81316c6148417f59bc72.js async></script><title>Installing from source - Mastodon文档 -Monado-</title><meta property="og:type" content="article"><meta property="og:url" content="https://docs.monado.ren/en/admin/install/"><meta name=description content="Instructional guide on creating your own Mastodon-powered website."><meta property="og:description" content="Instructional guide on creating your own Mastodon-powered website."><meta name=twitter:description content="Instructional guide on creating your own Mastodon-powered website."><meta name=twitter:title content="Installing from source"><meta name=twitter:site content="@joinmastodon"><link rel=canonical href=https://docs.monado.ren/en/admin/install/></head><body><div class="container sidebar-layout"><nav class=sidebar><a class=brand href=/><img class=link-logo src=/brand.svg alt=Mastodon></a><ul><li><a href=/en/>What is Mastodon?</a></li><li><span class=sub-title>Using Mastodon</span><ul class=sub-menu><li><a href=/en/user/signup/>Signing up for an account</a></li><li><a href=/en/user/profile/>Setting up your profile</a></li><li><a href=/en/user/posting/>Posting toots</a></li><li><a href=/en/user/network/>Using the network features</a></li><li><a href=/en/user/moderating/>Dealing with unwanted content</a></li><li><a href=/en/user/discoverability/>Promoting yourself and others</a></li><li><a href=/en/user/preferences/>Set your preferences</a></li><li><a href=/en/user/contacts/>More settings</a></li><li><a href=/en/user/external/>Using Mastodon externally</a></li><li><a href=/en/user/moving/>Moving or leaving accounts</a></li><li><a href=/en/user/run-your-own/>Running your own server</a></li></ul></li><li><span class=sub-title>Running Mastodon</span><ul class=sub-menu><li><a href=/en/admin/prerequisites/>Preparing your machine</a></li><li><a href=/en/admin/install/ class=active>Installing from source</a></li><li><a href=/en/admin/config/>Configuring your environment</a></li><li><a href=/en/admin/optional/>Installing optional features</a><ul class=sub-menu><li><a href=/en/admin/optional/elasticsearch/>Full-text search</a></li><li><a href=/en/admin/optional/tor/>Hidden services</a></li><li><a href=/en/admin/optional/sso/>Single Sign On</a></li></ul></li><li><a href=/en/admin/setup/>Setting up your new instance</a></li><li><a href=/en/admin/tootctl/>Using the admin CLI</a></li><li><a href=/en/admin/upgrading/>Upgrading to a new release</a></li><li><a href=/en/admin/backups/>Backing up your server</a></li><li><a href=/en/admin/migrating/>Migrating to a new machine</a></li><li><a href=/en/admin/scaling/>Scaling up your server</a></li><li><a href=/en/admin/moderation/>Moderation actions</a></li><li><a href=/en/admin/troubleshooting/>Troubleshooting errors</a><ul class=sub-menu><li><a href=/en/admin/troubleshooting/index-corruption/>Database index corruption</a></li></ul></li></ul></li><li><span class=sub-title>Developing Mastodon apps</span><ul class=sub-menu><li><a href=/en/client/intro/>Getting started with the API</a></li><li><a href=/en/client/public/>Playing with public data</a></li><li><a href=/en/client/token/>Obtaining client app access</a></li><li><a href=/en/client/authorized/>Logging in with an account</a></li><li><a href=/en/client/guidelines/>Guidelines and best practices</a></li><li><a href=/en/client/libraries/>Libraries and implementations</a></li></ul></li><li><span class=sub-title>Contributing to Mastodon</span><ul class=sub-menu><li><a href=/en/dev/overview/>Technical overview</a></li><li><a href=/en/dev/setup/>Setting up a dev environment</a></li><li><a href=/en/dev/code/>Code structure</a></li><li><a href=/en/dev/routes/>Routes</a></li><li><a href=/en/dev/disclosure/>Bug bounties and responsible disclosure</a></li></ul></li><li><span class=sub-title>Spec compliance</span><ul class=sub-menu><li><a href=/en/spec/activitypub/>ActivityPub</a></li><li><a href=/en/spec/webfinger/>WebFinger</a></li><li><a href=/en/spec/security/>Security</a></li><li><a href=/en/spec/microformats/>Microformats</a></li><li><a href=/en/spec/oauth/>OAuth</a></li><li><a href=/en/spec/bearcaps/>Bearcaps</a></li></ul></li><li><span class=sub-title>REST API</span><ul class=sub-menu><li><a href=/en/api/oauth-scopes/>OAuth Scopes</a></li><li><a href=/en/api/rate-limits/>Rate limits</a></li></ul></li><li><span class=sub-title>API Methods</span><ul class=sub-menu><li><a href=/en/methods/apps/>apps</a><ul class=sub-menu><li><a href=/en/methods/apps/oauth/>oauth</a></li></ul></li><li><a href=/en/methods/accounts/>accounts</a><ul class=sub-menu><li><a href=/en/methods/accounts/bookmarks/>bookmarks</a></li><li><a href=/en/methods/accounts/favourites/>favourites</a></li><li><a href=/en/methods/accounts/mutes/>mutes</a></li><li><a href=/en/methods/accounts/blocks/>blocks</a></li><li><a href=/en/methods/accounts/domain_blocks/>domain_blocks</a></li><li><a href=/en/methods/accounts/filters/>filters</a></li><li><a href=/en/methods/accounts/reports/>reports</a></li><li><a href=/en/methods/accounts/follow_requests/>follow_requests</a></li><li><a href=/en/methods/accounts/endorsements/>endorsements</a></li><li><a href=/en/methods/accounts/featured_tags/>featured_tags</a></li><li><a href=/en/methods/accounts/preferences/>preferences</a></li><li><a href=/en/methods/accounts/suggestions/>suggestions</a></li></ul></li><li><a href=/en/methods/statuses/>statuses</a><ul class=sub-menu><li><a href=/en/methods/statuses/media/>media</a></li><li><a href=/en/methods/statuses/polls/>polls</a></li><li><a href=/en/methods/statuses/scheduled_statuses/>scheduled_statuses</a></li></ul></li><li><a href=/en/methods/timelines/>timelines</a><ul class=sub-menu><li><a href=/en/methods/timelines/conversations/>conversations</a></li><li><a href=/en/methods/timelines/lists/>lists</a></li><li><a href=/en/methods/timelines/markers/>markers</a></li><li><a href=/en/methods/timelines/streaming/>streaming</a></li></ul></li><li><a href=/en/methods/notifications/>notifications</a><ul class=sub-menu><li><a href=/en/methods/notifications/push/>push</a></li></ul></li><li><a href=/en/methods/search/>search</a></li><li><a href=/en/methods/instance/>instance</a><ul class=sub-menu><li><a href=/en/methods/instance/trends/>trends</a></li><li><a href=/en/methods/instance/directory/>directory</a></li><li><a href=/en/methods/instance/custom_emojis/>custom_emojis</a></li></ul></li><li><a href=/en/methods/admin/>admin</a></li><li><a href=/en/methods/announcements/>announcements</a></li><li><a href=/en/methods/proofs/>proofs</a></li><li><a href=/en/methods/oembed/>oembed</a></li></ul></li><li><span class=sub-title>API Entities</span><ul class=sub-menu><li><a href=/en/entities/account/>Account</a></li><li><a href=/en/entities/activity/>Activity</a></li><li><a href=/en/entities/admin-account/>Admin::Account</a></li><li><a href=/en/entities/admin-report/>Admin::Report</a></li><li><a href=/en/entities/announcement/>Announcement</a></li><li><a href=/en/entities/announcementreaction/>AnnouncementReaction</a></li><li><a href=/en/entities/application/>Application</a></li><li><a href=/en/entities/attachment/>Attachment</a></li><li><a href=/en/entities/card/>Card</a></li><li><a href=/en/entities/context/>Context</a></li><li><a href=/en/entities/conversation/>Conversation</a></li><li><a href=/en/entities/emoji/>Emoji</a></li><li><a href=/en/entities/error/>Error</a></li><li><a href=/en/entities/featuredtag/>FeaturedTag</a></li><li><a href=/en/entities/field/>Field</a></li><li><a href=/en/entities/filter/>Filter</a></li><li><a href=/en/entities/history/>History</a></li><li><a href=/en/entities/identityproof/>IdentityProof</a></li><li><a href=/en/entities/instance/>Instance</a></li><li><a href=/en/entities/list/>List</a></li><li><a href=/en/entities/marker/>Marker</a></li><li><a href=/en/entities/mention/>Mention</a></li><li><a href=/en/entities/notification/>Notification</a></li><li><a href=/en/entities/poll/>Poll</a></li><li><a href=/en/entities/preferences/>Preferences</a></li><li><a href=/en/entities/pushsubscription/>PushSubscription</a></li><li><a href=/en/entities/relationship/>Relationship</a></li><li><a href=/en/entities/report/>Report</a></li><li><a href=/en/entities/results/>Results</a></li><li><a href=/en/entities/scheduledstatus/>ScheduledStatus</a></li><li><a href=/en/entities/source/>Source</a></li><li><a href=/en/entities/status/>Status</a></li><li><a href=/en/entities/tag/>Tag</a></li><li><a href=/en/entities/token/>Token</a></li></ul></li></ul></nav><main><h1>Installing from source</h1><p>Instructional guide on creating your own Mastodon-powered website.</p><aside><nav id=TableOfContents><ul><li><ul><li><a href=#pre-requisites>Pre-requisites</a></li><li><a href=#setup>Setup</a></li></ul></li></ul></nav></aside><div class=e-content><h2 id=pre-requisites>Pre-requisites</h2><ul><li>A machine running <strong>Ubuntu 18.04</strong> that you have root access to</li><li>A <strong>domain name</strong> (or a subdomain) for the Mastodon server, e.g. <code>example.com</code></li><li>An e-mail delivery service or other <strong>SMTP server</strong></li></ul><p>You will be running the commands as root. If you aren’t already root, switch to root:</p><h3 id=system-repositories>System repositories</h3><p>Make sure curl is installed first:</p><h4 id=node-js>Node.js</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -sL https://deb.nodesource.com/setup_12.x | bash -
</code></pre></div><h4 id=yarn>Yarn</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
<span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;deb https://dl.yarnpkg.com/debian/ stable main&#34;</span> | tee /etc/apt/sources.list.d/yarn.list
</code></pre></div><h3 id=system-packages>System packages</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apt update
apt install -y <span style=color:#f1fa8c>\
</span><span style=color:#f1fa8c></span>  imagemagick ffmpeg libpq-dev libxml2-dev libxslt1-dev file git-core <span style=color:#f1fa8c>\
</span><span style=color:#f1fa8c></span>  g++ libprotobuf-dev protobuf-compiler pkg-config nodejs gcc autoconf <span style=color:#f1fa8c>\
</span><span style=color:#f1fa8c></span>  bison build-essential libssl-dev libyaml-dev libreadline6-dev <span style=color:#f1fa8c>\
</span><span style=color:#f1fa8c></span>  zlib1g-dev libncurses5-dev libffi-dev libgdbm-dev <span style=color:#f1fa8c>\
</span><span style=color:#f1fa8c></span>  nginx redis-server redis-tools postgresql postgresql-contrib <span style=color:#f1fa8c>\
</span><span style=color:#f1fa8c></span>  certbot python-certbot-nginx yarn libidn11-dev libicu-dev libjemalloc-dev
</code></pre></div><h3 id=installing-ruby>Installing Ruby</h3><p>We will be using rbenv to manage Ruby versions, because it’s easier to get the right versions and to update once a newer release comes out. rbenv must be installed for a single Linux user, therefore, first we must create the user Mastodon will be running as:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>adduser --disabled-login mastodon
</code></pre></div><p>We can then switch to the user:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>su - mastodon
</code></pre></div><p>And proceed to install rbenv and rbenv-build:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git clone https://github.com/rbenv/rbenv.git ~/.rbenv
<span style=color:#8be9fd;font-style:italic>cd</span> ~/.rbenv <span style=color:#ff79c6>&amp;&amp;</span> src/configure <span style=color:#ff79c6>&amp;&amp;</span> make -C src
<span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#39;export PATH=&#34;$HOME/.rbenv/bin:$PATH&#34;&#39;</span> &gt;&gt; ~/.bashrc
<span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#39;eval &#34;$(rbenv init -)&#34;&#39;</span> &gt;&gt; ~/.bashrc
<span style=color:#8be9fd;font-style:italic>exec</span> bash
git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
</code></pre></div><p>Once this is done, we can install the correct Ruby version:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8be9fd;font-style:italic>RUBY_CONFIGURE_OPTS</span><span style=color:#ff79c6>=</span>--with-jemalloc rbenv install 2.7.2
rbenv global 2.7.2
</code></pre></div><p>We’ll also need to install bundler:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gem install bundler --no-document
</code></pre></div><p>Return to the root user:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8be9fd;font-style:italic>exit</span>
</code></pre></div><h2 id=setup>Setup</h2><h3 id=setting-up-postgresql>Setting up PostgreSQL</h3><h4 id=performance-configuration-optional>Performance configuration (optional)</h4><p>For optimal performance, you may use <a href=https://pgtune.leopard.in.ua/#/>pgTune</a> to generate an appropriate configuration and edit values in <code>/etc/postgresql/9.6/main/postgresql.conf</code> before restarting PostgreSQL with <code>systemctl restart postgresql</code></p><h4 id=creating-a-user>Creating a user</h4><p>You will need to create a PostgreSQL user that Mastodon could use. It is easiest to go with “ident” authentication in a simple setup, i.e. the PostgreSQL user does not have a separate password and can be used by the Linux user with the same username.</p><p>Open the prompt:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo -u postgres psql
</code></pre></div><p>In the prompt, execute:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#ff79c6>CREATE</span> <span style=color:#ff79c6>USER</span> mastodon <span style=color:#ff79c6>CREATEDB</span>;
\q
</code></pre></div><p>Done!</p><h3 id=setting-up-mastodon>Setting up Mastodon</h3><p>It is time to download the Mastodon code. Switch to the mastodon user:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>su - mastodon
</code></pre></div><h4 id=checking-out-the-code>Checking out the code</h4><p>Use git to download the latest stable release of Mastodon:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git clone https://github.com/tootsuite/mastodon.git live <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>cd</span> live
git checkout <span style=color:#ff79c6>$(</span>git tag -l | grep -v <span style=color:#f1fa8c>&#39;rc[0-9]*$&#39;</span> | sort -V | tail -n 1<span style=color:#ff79c6>)</span>
</code></pre></div><h4 id=installing-the-last-dependencies>Installing the last dependencies</h4><p>Now to install Ruby and JavaScript dependencies:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bundle config deployment <span style=color:#f1fa8c>&#39;true&#39;</span>
bundle config without <span style=color:#f1fa8c>&#39;development test&#39;</span>
bundle install -j<span style=color:#ff79c6>$(</span>getconf _NPROCESSORS_ONLN<span style=color:#ff79c6>)</span>
yarn install --pure-lockfile
</code></pre></div><div class="hint hint-info"><div class=hint-icon><i class="fa fa-info-circle"></i></div>The two <code>bundle config</code> commands are only needed the first time you're installing dependencies. If you're going to be updating or re-installing dependencies later, just <code>bundle install</code> will be enough.</div><h4 id=generating-a-configuration>Generating a configuration</h4><p>Run the interactive setup wizard:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8be9fd;font-style:italic>RAILS_ENV</span><span style=color:#ff79c6>=</span>production bundle <span style=color:#8be9fd;font-style:italic>exec</span> rake mastodon:setup
</code></pre></div><p>This will:</p><ul><li>Create a configuration file</li><li>Run asset precompilation</li><li>Create the database schema</li></ul><p>The configuration file is saved as <code>.env.production</code>. You can review and edit it to your liking. Refer to the <a href=/en/admin/config/>documentation on configuration.</a></p><p>You’re done with the mastodon user for now, so switch back to root:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8be9fd;font-style:italic>exit</span>
</code></pre></div><h3 id=setting-up-nginx>Setting up nginx</h3><p>Copy the configuration template for nginx from the Mastodon directory:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cp /home/mastodon/live/dist/nginx.conf /etc/nginx/sites-available/mastodon
ln -s /etc/nginx/sites-available/mastodon /etc/nginx/sites-enabled/mastodon
</code></pre></div><p>Then edit <code>/etc/nginx/sites-available/mastodon</code> to replace <code>example.com</code> with your own domain name, and make any other adjustments you might need.</p><p>Reload nginx for the changes to take effect:</p><h3 id=acquiring-a-ssl-certificate>Acquiring a SSL certificate</h3><p>We’ll use Let’s Encrypt to get a free SSL certificate:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>certbot --nginx -d example.com
</code></pre></div><p>This will obtain the certificate, automatically update <code>/etc/nginx/sites-available/mastodon</code> to use the new certificate, and reload nginx for the changes to take effect.</p><p>At this point you should be able to visit your domain in the browser and see the elephant hitting the computer screen error page. This is because we haven’t started the Mastodon process yet.</p><h3 id=setting-up-systemd-services>Setting up systemd services</h3><p>Copy the systemd service templates from the Mastodon directory:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cp /home/mastodon/live/dist/mastodon-*.service /etc/systemd/system/
</code></pre></div><p>If you deviated from the defaults at any point, check that the username and paths are correct:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#8be9fd;font-style:italic>$EDITOR</span> /etc/systemd/system/mastodon-*.service
</code></pre></div><p>Finally, start and enable the new systemd services:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>systemctl daemon-reload
systemctl <span style=color:#8be9fd;font-style:italic>enable</span> --now mastodon-web mastodon-sidekiq mastodon-streaming
</code></pre></div><p>They will now automatically start at boot.</p><div class="hint hint-success"><div class=hint-icon><i class="fa fa-check-circle"></i></div><strong>Hurray! This is it. You can visit your domain in the browser now!</strong></div><p style=color:#687590>Last updated March 4, 2021 · <a href=https://github.com/chasedream1129/mastodon-docs/tree/master/content/en/admin/install.md style=color:#687590>Improve this page</a><br>Also available in:
<a href=https://docs.monado.ren/admin/install/ style=color:#687590 hreflang=zh-cn>简体中文</a></p></div></main></div></body></html>