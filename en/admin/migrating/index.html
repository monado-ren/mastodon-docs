<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=/favicon.ico><link rel=stylesheet href=https://docs.monado.ren/style.min.ac66b095598a93816a47e5ef5b071058047fa4bd8770cb4515ca10c1ad6f91c0.css><script src=https://docs.monado.ren/main.min.db37c27117ff8400e5e30549f6806d2bc825668b596d81316c6148417f59bc72.js async></script><title>Migrating to a new machine - Mastodon文档 -Monado-</title><meta property="og:type" content="article"><meta property="og:url" content="https://docs.monado.ren/en/admin/migrating/"><meta name=description content="Copying your Mastodon installation to a new server without losing anything."><meta property="og:description" content="Copying your Mastodon installation to a new server without losing anything."><meta name=twitter:description content="Copying your Mastodon installation to a new server without losing anything."><meta name=twitter:title content="Migrating to a new machine"><meta name=twitter:site content="@joinmastodon"><link rel=canonical href=https://docs.monado.ren/en/admin/migrating/></head><body><div class="container sidebar-layout"><nav class=sidebar><a class=brand href=/><img class=link-logo src=/brand.svg alt=Mastodon></a><ul><li><a href=/en/>What is Mastodon?</a></li><li><span class=sub-title>Using Mastodon</span><ul class=sub-menu><li><a href=/en/user/signup/>Signing up for an account</a></li><li><a href=/en/user/profile/>Setting up your profile</a></li><li><a href=/en/user/posting/>Posting toots</a></li><li><a href=/en/user/network/>Using the network features</a></li><li><a href=/en/user/moderating/>Dealing with unwanted content</a></li><li><a href=/en/user/discoverability/>Promoting yourself and others</a></li><li><a href=/en/user/preferences/>Set your preferences</a></li><li><a href=/en/user/contacts/>More settings</a></li><li><a href=/en/user/external/>Using Mastodon externally</a></li><li><a href=/en/user/moving/>Moving or leaving accounts</a></li><li><a href=/en/user/run-your-own/>Running your own server</a></li></ul></li><li><span class=sub-title>Running Mastodon</span><ul class=sub-menu><li><a href=/en/admin/prerequisites/>Preparing your machine</a></li><li><a href=/en/admin/install/>Installing from source</a></li><li><a href=/en/admin/config/>Configuring your environment</a></li><li><a href=/en/admin/optional/>Installing optional features</a><ul class=sub-menu><li><a href=/en/admin/optional/elasticsearch/>Full-text search</a></li><li><a href=/en/admin/optional/tor/>Hidden services</a></li><li><a href=/en/admin/optional/sso/>Single Sign On</a></li></ul></li><li><a href=/en/admin/setup/>Setting up your new instance</a></li><li><a href=/en/admin/tootctl/>Using the admin CLI</a></li><li><a href=/en/admin/upgrading/>Upgrading to a new release</a></li><li><a href=/en/admin/backups/>Backing up your server</a></li><li><a href=/en/admin/migrating/ class=active>Migrating to a new machine</a></li><li><a href=/en/admin/scaling/>Scaling up your server</a></li><li><a href=/en/admin/moderation/>Moderation actions</a></li><li><a href=/en/admin/troubleshooting/>Troubleshooting errors</a><ul class=sub-menu><li><a href=/en/admin/troubleshooting/index-corruption/>Database index corruption</a></li></ul></li></ul></li><li><span class=sub-title>Developing Mastodon apps</span><ul class=sub-menu><li><a href=/en/client/intro/>Getting started with the API</a></li><li><a href=/en/client/public/>Playing with public data</a></li><li><a href=/en/client/token/>Obtaining client app access</a></li><li><a href=/en/client/authorized/>Logging in with an account</a></li><li><a href=/en/client/guidelines/>Guidelines and best practices</a></li><li><a href=/en/client/libraries/>Libraries and implementations</a></li></ul></li><li><span class=sub-title>Contributing to Mastodon</span><ul class=sub-menu><li><a href=/en/dev/overview/>Technical overview</a></li><li><a href=/en/dev/setup/>Setting up a dev environment</a></li><li><a href=/en/dev/code/>Code structure</a></li><li><a href=/en/dev/routes/>Routes</a></li><li><a href=/en/dev/disclosure/>Bug bounties and responsible disclosure</a></li></ul></li><li><span class=sub-title>Spec compliance</span><ul class=sub-menu><li><a href=/en/spec/activitypub/>ActivityPub</a></li><li><a href=/en/spec/webfinger/>WebFinger</a></li><li><a href=/en/spec/security/>Security</a></li><li><a href=/en/spec/microformats/>Microformats</a></li><li><a href=/en/spec/oauth/>OAuth</a></li><li><a href=/en/spec/bearcaps/>Bearcaps</a></li></ul></li><li><span class=sub-title>REST API</span><ul class=sub-menu><li><a href=/en/api/oauth-scopes/>OAuth Scopes</a></li><li><a href=/en/api/rate-limits/>Rate limits</a></li></ul></li><li><span class=sub-title>API Methods</span><ul class=sub-menu><li><a href=/en/methods/apps/>apps</a><ul class=sub-menu><li><a href=/en/methods/apps/oauth/>oauth</a></li></ul></li><li><a href=/en/methods/accounts/>accounts</a><ul class=sub-menu><li><a href=/en/methods/accounts/bookmarks/>bookmarks</a></li><li><a href=/en/methods/accounts/favourites/>favourites</a></li><li><a href=/en/methods/accounts/mutes/>mutes</a></li><li><a href=/en/methods/accounts/blocks/>blocks</a></li><li><a href=/en/methods/accounts/domain_blocks/>domain_blocks</a></li><li><a href=/en/methods/accounts/filters/>filters</a></li><li><a href=/en/methods/accounts/reports/>reports</a></li><li><a href=/en/methods/accounts/follow_requests/>follow_requests</a></li><li><a href=/en/methods/accounts/endorsements/>endorsements</a></li><li><a href=/en/methods/accounts/featured_tags/>featured_tags</a></li><li><a href=/en/methods/accounts/preferences/>preferences</a></li><li><a href=/en/methods/accounts/suggestions/>suggestions</a></li></ul></li><li><a href=/en/methods/statuses/>statuses</a><ul class=sub-menu><li><a href=/en/methods/statuses/media/>media</a></li><li><a href=/en/methods/statuses/polls/>polls</a></li><li><a href=/en/methods/statuses/scheduled_statuses/>scheduled_statuses</a></li></ul></li><li><a href=/en/methods/timelines/>timelines</a><ul class=sub-menu><li><a href=/en/methods/timelines/conversations/>conversations</a></li><li><a href=/en/methods/timelines/lists/>lists</a></li><li><a href=/en/methods/timelines/markers/>markers</a></li><li><a href=/en/methods/timelines/streaming/>streaming</a></li></ul></li><li><a href=/en/methods/notifications/>notifications</a><ul class=sub-menu><li><a href=/en/methods/notifications/push/>push</a></li></ul></li><li><a href=/en/methods/search/>search</a></li><li><a href=/en/methods/instance/>instance</a><ul class=sub-menu><li><a href=/en/methods/instance/trends/>trends</a></li><li><a href=/en/methods/instance/directory/>directory</a></li><li><a href=/en/methods/instance/custom_emojis/>custom_emojis</a></li></ul></li><li><a href=/en/methods/admin/>admin</a></li><li><a href=/en/methods/announcements/>announcements</a></li><li><a href=/en/methods/proofs/>proofs</a></li><li><a href=/en/methods/oembed/>oembed</a></li></ul></li><li><span class=sub-title>API Entities</span><ul class=sub-menu><li><a href=/en/entities/account/>Account</a></li><li><a href=/en/entities/activity/>Activity</a></li><li><a href=/en/entities/admin-account/>Admin::Account</a></li><li><a href=/en/entities/admin-report/>Admin::Report</a></li><li><a href=/en/entities/announcement/>Announcement</a></li><li><a href=/en/entities/announcementreaction/>AnnouncementReaction</a></li><li><a href=/en/entities/application/>Application</a></li><li><a href=/en/entities/attachment/>Attachment</a></li><li><a href=/en/entities/card/>Card</a></li><li><a href=/en/entities/context/>Context</a></li><li><a href=/en/entities/conversation/>Conversation</a></li><li><a href=/en/entities/emoji/>Emoji</a></li><li><a href=/en/entities/error/>Error</a></li><li><a href=/en/entities/featuredtag/>FeaturedTag</a></li><li><a href=/en/entities/field/>Field</a></li><li><a href=/en/entities/filter/>Filter</a></li><li><a href=/en/entities/history/>History</a></li><li><a href=/en/entities/identityproof/>IdentityProof</a></li><li><a href=/en/entities/instance/>Instance</a></li><li><a href=/en/entities/list/>List</a></li><li><a href=/en/entities/marker/>Marker</a></li><li><a href=/en/entities/mention/>Mention</a></li><li><a href=/en/entities/notification/>Notification</a></li><li><a href=/en/entities/poll/>Poll</a></li><li><a href=/en/entities/preferences/>Preferences</a></li><li><a href=/en/entities/pushsubscription/>PushSubscription</a></li><li><a href=/en/entities/relationship/>Relationship</a></li><li><a href=/en/entities/report/>Report</a></li><li><a href=/en/entities/results/>Results</a></li><li><a href=/en/entities/scheduledstatus/>ScheduledStatus</a></li><li><a href=/en/entities/source/>Source</a></li><li><a href=/en/entities/status/>Status</a></li><li><a href=/en/entities/tag/>Tag</a></li><li><a href=/en/entities/token/>Token</a></li></ul></li></ul></nav><main><h1>Migrating to a new machine</h1><p>Copying your Mastodon installation to a new server without losing anything.</p><aside><nav id=TableOfContents><ul><li><ul><li><a href=#basic-steps>Basic steps</a></li><li><a href=#detailed-steps>Detailed steps</a></li></ul></li></ul></nav></aside><div class=e-content><p>Sometimes, for various reasons, you may want to migrate your Mastodon instance from one server to another. Fortunately this is not too difficult of a process, although it may result in some downtime.</p><div class="hint hint-info"><div class=hint-icon><i class="fa fa-info-circle"></i></div>This guide was written with Ubuntu Server in mind; your mileage may vary for other setups.</div><h2 id=basic-steps>Basic steps</h2><ol><li>Set up a new Mastodon server using the <a href=/en/admin/install/>Production Guide</a> (however, don’t run <code>mastodon:setup</code>).</li><li>Stop Mastodon on the old server (e.g. <code>systemctl stop 'mastodon-*.service'</code>).</li><li>Dump and load the Postgres database using the instructions below.</li><li>Copy the <code>system/</code> files using the instructions below. (Note: if you’re using S3, you can skip this step.)</li><li>Copy the <code>.env.production</code> file.</li><li>Run <code>RAILS_ENV=production bundle exec rails assets:precompile</code> to compile Mastodon</li><li>Run <code>RAILS_ENV=production ./bin/tootctl feeds build</code> to rebuild the home timelines for each user.</li><li>Start Mastodon on the new server.</li><li>Update your DNS settings to point to the new server.</li><li>Update or copy your Nginx configuration, re-run LetsEncrypt as necessary.</li><li>Enjoy your new server!</li></ol><h2 id=detailed-steps>Detailed steps</h2><h3 id=what-data-needs-to-be-migrated>What data needs to be migrated</h3><p>At a high level, you’ll need to copy over the following:</p><ul><li>The <code>~/live/public/system</code> directory, which contains user-uploaded images and videos (if using S3, you don’t need this)</li><li>The Postgres database (using <a href=https://www.postgresql.org/docs/9.1/static/backup-dump.html>pg_dump</a>)</li><li>The <code>~/live/.env.production</code> file, which contains server config and secrets</li></ul><p>Less crucially, you’ll probably also want to copy the following for convenience:</p><ul><li>The nginx config (under <code>/etc/nginx/sites-available/default</code>)</li><li>The systemd config files (<code>/etc/systemd/system/mastodon-*.service</code>), which may contain your server tweaks and customizations</li><li>The pgbouncer configuration under <code>/etc/pgbouncer</code> (if you’re using it)</li></ul><h3 id=dump-and-load-postgres>Dump and load Postgres</h3><p>Instead of running <code>mastodon:setup</code>, we’re going to create an empty Postgres database using the <code>template0</code> database (which is useful when restoring a Postgres dump, <a href=https://www.postgresql.org/docs/9.1/static/backup-dump.html#BACKUP-DUMP-RESTORE>as described in the pg_dump documentation</a>).</p><p>Run this as the <code>mastodon</code> user on your old system:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>pg_dump -Fc mastodon_production -f backup.dump
</code></pre></div><p>Copy the <code>backup.dump</code> file over, using <code>rsync</code> or <code>scp</code>. Then on the new system, create an empty database as the <code>mastodon</code> user:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>createdb -T template0 mastodon_production
</code></pre></div><p>Then import it:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>pg_restore -Fc -U mastodon -n public --no-owner --role<span style=color:#ff79c6>=</span>mastodon <span style=color:#f1fa8c>\
</span><span style=color:#f1fa8c></span>  -d mastodon_production backup.dump
</code></pre></div><p>(Note that if the username is not <code>mastodon</code> on the new server, you should change the <code>-U</code> AND <code>--role</code> values above. It’s okay if the username is different between the two servers.)</p><h3 id=copy-files>Copy files</h3><p>This will probably take some time, and you’ll want to avoid re-copying unnecessarily, so using <code>rsync</code> is recommended. On your old machine, as the <code>mastodon</code> user, run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>rsync -avz ~/live/public/system/ mastodon@example.com:~/live/public/system/
</code></pre></div><p>You’ll want to re-run this if any of the files on the old server change.</p><p>You should also copy over the <code>.env.production</code> file, which contains secrets.</p><p>Optionally, you may copy over the nginx, systemd, and pgbouncer config files, or rewrite them from scratch.</p><h3 id=during-migration>During migration</h3><p>You can edit the <code>~/live/public/500.html</code> page on the old machine if you want to show a nice error message to let existing users know that a migration is in progress.</p><p>You’ll probably also want to set the DNS TTL to something small (30-60 minutes) about a day in advance, so that DNS can propagate quickly once you point it to the new IP address.</p><h3 id=after-migrating>After migrating</h3><p>You can check <a href=https://whatsmydns.net/>whatsmydns.net</a> to see the progress of DNS propagation. To jumpstart the process, you can always edit your own <code>/etc/hosts</code> file to point to your new server so you can start playing around with it early.</p><p style=color:#687590>Last updated May 6, 2021 · <a href=https://github.com/chasedream1129/mastodon-docs/tree/master/content/en/admin/migrating.md style=color:#687590>Improve this page</a><br>Also available in:
<a href=https://docs.monado.ren/admin/migrating/ style=color:#687590 hreflang=zh-cn>简体中文</a></p></div></main></div></body></html>