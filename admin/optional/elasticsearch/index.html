<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=/favicon.ico><link rel=stylesheet href=https://docs.monado.ren/style.min.ac66b095598a93816a47e5ef5b071058047fa4bd8770cb4515ca10c1ad6f91c0.css><script src=https://docs.monado.ren/main.min.db37c27117ff8400e5e30549f6806d2bc825668b596d81316c6148417f59bc72.js async></script><title>全文搜索 - Mastodon文档 -Monado-</title><meta property="og:type" content="article"><meta property="og:url" content="https://docs.monado.ren/admin/optional/elasticsearch/"><meta name=description content="设置ElasticSearch来搜索自己发出的嘟文、自己喜欢的嘟文、自己的书签和自己被提及的嘟文。"><meta property="og:description" content="设置ElasticSearch来搜索自己发出的嘟文、自己喜欢的嘟文、自己的书签和自己被提及的嘟文。"><meta name=twitter:description content="设置ElasticSearch来搜索自己发出的嘟文、自己喜欢的嘟文、自己的书签和自己被提及的嘟文。"><meta name=twitter:title content="全文搜索"><meta name=twitter:site content="@joinmastodon"><link rel=canonical href=https://docs.monado.ren/admin/optional/elasticsearch/></head><body><div class="container sidebar-layout"><nav class=sidebar><a class=brand href=/><img class=link-logo src=/brand.svg alt=Mastodon></a><ul><li><a href=/>什么是Mastodon？</a></li><li><span class=sub-title>使用Mastodon</span><ul class=sub-menu><li><a href=/user/signup/>创建一个帐户</a></li><li><a href=/user/profile/>设置个人资料</a></li><li><a href=/user/posting/>发布嘟文</a></li><li><a href=/user/network/>使用社交功能</a></li><li><a href=/user/moderating/>处理不想要的内容</a></li><li><a href=/user/discoverability/>推广自己和他人</a></li><li><a href=/user/preferences/>设置你的首选项</a></li><li><a href=/user/contacts/>更多设置</a></li><li><a href=/user/external/>站外使用Mastodon</a></li><li><a href=/user/pwa/>使用PWA版Mastodon</a></li><li><a href=/user/moving/>迁移或删除帐户</a></li><li><a href=/user/run-your-own/>运行自己的服务器</a></li></ul></li><li><span class=sub-title>运营Mastodon</span><ul class=sub-menu><li><a href=/admin/prerequisites/>准备你的机器</a></li><li><a href=/admin/install/>从源中安装</a></li><li><a href=/admin/config/>设置你的环境</a></li><li><a href=/admin/optional/>安装可选特色功能</a><ul class=sub-menu><li><a href=/admin/optional/elasticsearch/ class=active>全文搜索</a></li><li><a href=/admin/optional/tor/>匿名服务</a></li><li><a href=/admin/optional/sso/>单点登录（SSO）</a></li></ul></li><li><a href=/admin/setup/>配置你的新实例</a></li><li><a href=/admin/tootctl/>使用管理命令行</a></li><li><a href=/admin/upgrading/>升级到新版本</a></li><li><a href=/admin/backups/>备份你的服务器</a></li><li><a href=/admin/migrating/>迁移到新机器</a></li><li><a href=/admin/scaling/>伸缩你的服务器</a></li><li><a href=/admin/moderation/>运营操作</a></li><li><a href=/admin/troubleshooting/>故障分析</a></li></ul></li><li><span class=sub-title>前往英文版查看更多</span><ul class=sub-menu><li><a href=/more/more/>更多</a></li></ul></li></ul></nav><main><h1>全文搜索</h1><p>设置ElasticSearch来搜索自己发出的嘟文、自己喜欢的嘟文、自己的书签和自己被提及的嘟文。</p><aside><nav id=TableOfContents><ul><li><ul><li><a href=#install>安装 ElasticSearch</a></li><li><a href=#config>配置 Mastodon</a></li><li><a href=#heading>其它语言的搜索优化</a></li></ul></li></ul></nav></aside><div class=e-content><p>当有可用ElasticSearch时，Mastodon支持全文搜索。Mastodon的全文搜索允许登录用户从他们自己的嘟文、他们喜欢的嘟文、他们的书签和他们被提及的嘟文中查找相应结果。Mastodon有意禁用了在全数据库搜索任意关键词的功能。</p><h2 id=install>安装 ElasticSearch</h2><p>ElasticSearch 需要 Java runtime。如果你还没有安装 Java，请立刻安装上它。以下操均假定你已经登录为<code>root</code>用户：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apt install openjdk-8-jre-headless
</code></pre></div><p>添加ElasticSearch官方软件仓库至apt：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -
<span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;deb https://artifacts.elastic.co/packages/6.x/apt stable main&#34;</span> | tee -a /etc/apt/sources.list.d/elastic-6.x.list
apt update
</code></pre></div><p>现在，你可以安装 ElasticSearch：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apt install elasticsearch
</code></pre></div><div class="hint hint-warning"><div class=hint-icon><i class="fa fa-exclamation-circle"></i></div><strong>安全警告：</strong> 默认情况下，ElasticSearch仅绑定于localhost，即无法从外部网络访问。你可以通过查看 <code>/etc/elasticsearch/elasticsearch.yml</code> 中的 <code>network.host</code> 来检查 ElasticSearch 绑定了哪些地址。考虑到由于缺乏认证层，任何能访问 ElasticSearch 的人都可以读取或修改里面的数据。因此，确保访问安全非常重要。如<a href=../../prerequisites/#install-a-firewall-and-only-whitelist-ssh-http-and-https-ports>主要安装说明</a>中所述，防火墙建议仅暴露了22、80、443端口。如果你是一个多主机配置，你必须知道如何保证内部流量安全。</div><p>启动 ElasticSearch：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl <span style=color:#8be9fd;font-style:italic>enable</span> elasticsearch
systemctl start elasticsearch
</code></pre></div><h2 id=config>配置 Mastodon</h2><p>编辑 <code>.env.production</code>，添加如下变量：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8be9fd;font-style:italic>ES_ENABLED</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>true</span>
<span style=color:#8be9fd;font-style:italic>ES_HOST</span><span style=color:#ff79c6>=</span>localhost
<span style=color:#8be9fd;font-style:italic>ES_PORT</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>9200</span>
</code></pre></div><p>如果你同一台机器上运行多个Mastodon服务器，你计划让它们使用同一个ElasticSearch，请确保他们都配置了互不重复的 <code>REDIS_NAMESPACE</code> 以分别他们的索引。如果你需要覆盖ElasticSearch索引前缀，你可以直接设置 <code>ES_PREFIX</code>。</p><p>保存新设置之后，使用如下命令创建ElasticSearch索引：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8be9fd;font-style:italic>RAILS_ENV</span><span style=color:#ff79c6>=</span>production bundle <span style=color:#8be9fd;font-style:italic>exec</span> rake chewy:upgrade
</code></pre></div><p>重启Mastodon进程以使新配置生效：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl restart mastodon-sidekiq
systemctl reload mastodon-web
</code></pre></div><p>现在，新的嘟文将会被写入ElasticSearch索引。最后一步是导入所有旧有数据。这将花费很长一段时间：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8be9fd;font-style:italic>RAILS_ENV</span><span style=color:#ff79c6>=</span>production bundle <span style=color:#8be9fd;font-style:italic>exec</span> rake chewy:sync
</code></pre></div><div class="hint hint-warning"><div class=hint-icon><i class="fa fa-exclamation-circle"></i></div><strong>兼容性提示：</strong> Ruby 2.6.0 由于已知Bug，无法进行上述操作。其它Ruby版本，例如：2.6.1，并不存在这个问题。</div><h2 id=heading>其它语言的搜索优化</h2><h3 id=chinese-search-optimize>中文搜索优化</h3><p>ElasticSearch默认使用标准分析器，这对于中文来说可能并不太适合。为了提高搜索体验，你可以安装特定语言的专用分析器。在创建ElasticSearch索引之前执行：</p><p>安装 <a href=https://github.com/medcl/elasticsearch-analysis-ik>elasticsearch-analysis-ik</a>、<a href=https://github.com/medcl/elasticsearch-analysis-stconvert>elasticsearch-analysis-stconvert</a> 插件至 ElasticSearch。</p><p>并对源码做出如下修改：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=font-weight:700>diff --git a/app/chewy/accounts_index.rb b/app/chewy/accounts_index.rb
</span><span style=font-weight:700></span><span style=color:#8b080b>--- a/app/chewy/accounts_index.rb
</span><span style=color:#8b080b></span><span style=font-weight:700>+++ b/app/chewy/accounts_index.rb
</span><span style=font-weight:700></span><span style=font-weight:700>@@ -4,7 +4,7 @@ class AccountsIndex &lt; Chewy::Index
</span><span style=font-weight:700></span>   settings index: { refresh_interval: &#39;5m&#39; }, analysis: {
     analyzer: {
       content: {
<span style=color:#8b080b>-        tokenizer: &#39;whitespace&#39;,
</span><span style=color:#8b080b></span><span style=font-weight:700>+        tokenizer: &#39;ik_max_word&#39;,
</span><span style=font-weight:700></span>         filter: %w(lowercase asciifolding cjk_width),
       },
 
<span style=font-weight:700>diff --git a/app/chewy/statuses_index.rb b/app/chewy/statuses_index.rb
</span><span style=font-weight:700></span><span style=color:#8b080b>--- a/app/chewy/statuses_index.rb
</span><span style=color:#8b080b></span><span style=font-weight:700>+++ b/app/chewy/statuses_index.rb
</span><span style=font-weight:700></span><span style=font-weight:700>@@ -16,9 +16,17 @@ class StatusesIndex &lt; Chewy::Index
</span><span style=font-weight:700></span>         language: &#39;possessive_english&#39;,
       },
     },
<span style=font-weight:700>+    char_filter: {
</span><span style=font-weight:700></span><span style=font-weight:700>+      tsconvert: {
</span><span style=font-weight:700></span><span style=font-weight:700>+        type: &#39;stconvert&#39;,
</span><span style=font-weight:700></span><span style=font-weight:700>+        keep_both: false,
</span><span style=font-weight:700></span><span style=font-weight:700>+        delimiter: &#39;#&#39;,
</span><span style=font-weight:700></span><span style=font-weight:700>+        convert_type: &#39;t2s&#39;,
</span><span style=font-weight:700></span><span style=font-weight:700>+      },
</span><span style=font-weight:700></span><span style=font-weight:700>+    },
</span><span style=font-weight:700></span>     analyzer: {
       content: {
<span style=color:#8b080b>-        tokenizer: &#39;uax_url_email&#39;,
</span><span style=color:#8b080b></span><span style=font-weight:700>+        tokenizer: &#39;ik_max_word&#39;,
</span><span style=font-weight:700></span>         filter: %w(
           english_possessive_stemmer
           lowercase
<span style=font-weight:700>@@ -27,6 +35,7 @@ class StatusesIndex &lt; Chewy::Index
</span><span style=font-weight:700></span>           english_stop
           english_stemmer
         ),
<span style=font-weight:700>+        char_filter: %w(tsconvert),
</span><span style=font-weight:700></span>       },
     },
   }
<span style=font-weight:700>diff --git a/app/chewy/tags_index.rb b/app/chewy/tags_index.rb
</span><span style=font-weight:700></span><span style=color:#8b080b>--- a/app/chewy/tags_index.rb
</span><span style=color:#8b080b></span><span style=font-weight:700>+++ b/app/chewy/tags_index.rb
</span><span style=font-weight:700></span><span style=font-weight:700>@@ -2,10 +2,19 @@
</span><span style=font-weight:700></span> 
 class TagsIndex &lt; Chewy::Index
   settings index: { refresh_interval: &#39;15m&#39; }, analysis: {
<span style=font-weight:700>+    char_filter: {
</span><span style=font-weight:700></span><span style=font-weight:700>+      tsconvert: {
</span><span style=font-weight:700></span><span style=font-weight:700>+        type: &#39;stconvert&#39;,
</span><span style=font-weight:700></span><span style=font-weight:700>+        keep_both: false,
</span><span style=font-weight:700></span><span style=font-weight:700>+        delimiter: &#39;#&#39;,
</span><span style=font-weight:700></span><span style=font-weight:700>+        convert_type: &#39;t2s&#39;,
</span><span style=font-weight:700></span><span style=font-weight:700>+      },
</span><span style=font-weight:700></span><span style=font-weight:700>+    },
</span><span style=font-weight:700></span>     analyzer: {
       content: {
<span style=color:#8b080b>-        tokenizer: &#39;keyword&#39;,
</span><span style=color:#8b080b></span><span style=font-weight:700>+        tokenizer: &#39;ik_max_word&#39;,
</span><span style=font-weight:700></span>         filter: %w(lowercase asciifolding cjk_width),
<span style=font-weight:700>+        char_filter: %w(tsconvert),
</span><span style=font-weight:700></span>       },
 
       edge_ngram: {
</code></pre></div><figure><p><strong>翻译状态：</strong>
本文是英文页面 <a href=/en/admin/optional/elasticsearch/>Full-text search</a> 的翻译，最后翻译时间：2020-05-05，点击<a href=https://github.com/chasedream1129/mastodon-docs/compare/ad1ef20f171c9f61439f32168987b0b4f9abd74b...master>这里</a>可以查看翻译后页面的改动。</p></figure><p style=color:#687590>最后更新于 October 7, 2020 · <a href=https://github.com/chasedream1129/mastodon-docs/tree/master/content/zh-cn/admin/optional/elasticsearch.md style=color:#687590>改进此页面</a><br>也可在此找到：
<a href=https://docs.monado.ren/en/admin/optional/elasticsearch/ style=color:#687590 hreflang=en>English</a></p></div></main></div></body></html>